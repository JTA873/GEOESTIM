<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>GEOESTIM - G√©oloc des projets du PEI de Toulouse</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js';
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA8nITJshSIhDAl0QT4uGLqJN4_ZCwT4EA",
            authDomain: "geoestim.firebaseapp.com",
            projectId: "geoestim",
            storageBucket: "geoestim.firebasestorage.app",
            messagingSenderId: "57133963308",
            appId: "1:57133963308:web:06b8479e5f5f6ea75b9989",
            measurementId: "G-V8DC3Q5GKC"
        };
        
        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Rendre les objets Firebase disponibles globalement
        window.firebaseDB = db;
        window.firebaseApp = app;
        window.firebaseAnalytics = analytics;
        
        console.log('üî• Firebase initialis√© avec succ√®s');
    </script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255,255,255,0.95); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .header h1 {
            background: linear-gradient(45deg, #003C71, #7FDBFF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.8em;
            margin: 0;
            font-weight: 600;
        }
        .section { 
            background: rgba(255,255,255,0.85); 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            transition: transform 0.2s ease;
        }
        .section:hover { transform: translateY(-2px); }
        
        #map { 
            height: 70vh; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .controls {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #003C71, #0074D9);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(0,60,113,0.2);
        }
        .btn:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,60,113,0.3);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-success { 
            background: linear-gradient(45deg, #4caf50, #45a049);
            box-shadow: 0 4px 15px rgba(76,175,80,0.3);
        }
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(76,175,80,0.4);
        }
        
        .upload-area {
            background: rgba(255,255,255,0.7);
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #ddd;
            margin: 15px 0;
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .stat-item { 
            background: linear-gradient(135deg, #003C71 0%, #0074D9 100%); 
            color: white;
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        .stat-item:hover { transform: scale(1.05); }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 12px;
        }
        th { 
            background: linear-gradient(45deg, #003C71, #0074D9); 
            color: white;
            padding: 8px 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 1.2;
        }
        td { 
            padding: 6px 8px; 
            border-bottom: 1px solid #f5f5f5;
            font-size: 11px;
            line-height: 1.3;
        }
        tr:hover { background: #f8f9fa; }
        
        .layer-control {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff40;
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 4px;
            margin-right: 10px;
            border-radius: 2px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4caf50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Contr√¥les suppl√©mentaires de la carte */
        .map-control-btn {
            display: block;
            width: 26px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            text-decoration: none;
            color: black;
            background: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .map-control-btn:hover {
            background: #f4f4f4;
            color: #007cff;
            transform: scale(1.05);
        }
        
        /* Panneau d'outils de mesure */
        .measure-tool-panel {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
        }
        
        .measure-tool-panel button {
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .measure-tool-panel button:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .color-btn {
            transition: all 0.2s ease;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .fullscreen-active {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999 !important;
        }
        
        /* Styles pour les filtres */
        #filters-section button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #filters-section select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÑ GEOESTIM</h1>
                
            </p>
            <p>G√©olocalisation des projets du PEI de Toulouse</p>
            <div style="background: linear-gradient(45deg, #4caf50, #2196f3); height: 4px; border-radius: 2px; margin: 15px auto; width: 200px;"></div>
        </div>
        
        <!-- Upload des fichiers et Stats sur la m√™me ligne -->
        <div class="section">
            <h3>üìÅ Configuration des Fichiers</h3>
            <div style="display: flex; gap: 30px; align-items: flex-start;">
                <!-- Zone Upload (c√¥t√© gauche) -->
                <div class="upload-area" style="flex: 1; max-width: 500px; background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px dashed #dee2e6; border-radius: 12px; padding: 30px 25px; transition: all 0.3s ease;">
                    
                    <div class="upload-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 14px;">üìä Fichier ADMIN (projets C6)</label>
                        <input type="file" id="admin-file" accept=".xlsx,.xls" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; background: #fff; font-size: 13px;">
                        <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Format Excel avec donn√©es C6 HBPTE</div>
                    </div>
                    
                    <div class="upload-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 14px;">üóÇÔ∏è Fichier BPTE (op√©rations GEREMI)</label>
                        <input type="file" id="bpte-file" accept=".xlsx,.xls" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; background: #fff; font-size: 13px;">
                        <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Format Excel avec comptes GEREMI</div>
                    </div>
                    
                    <div class="control-buttons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; align-items: center;">
                        <button class="btn btn-success" onclick="processFiles()" id="process-btn" disabled style="flex: 1; min-width: 200px;">
                            <span class="loading" id="loading-icon" style="display: none;"></span>
                            üöÑ ANALYSER ET CARTOGRAPHIER
                        </button>
                        <button class="btn" onclick="loadDataFromFirebaseOnStart()" title="Charger les donn√©es depuis Firebase" style="min-width: 180px;">
                            üî• CHARGER FIREBASE
                        </button>
                        <button class="btn" onclick="saveSNCFDataToFirebase()" title="Initialiser les donn√©es SNCF dans Firebase" style="min-width: 180px;">
                            üíæ INIT FIREBASE
                        </button>
                    </div>
                    
                    <div class="progress-bar" id="progress-bar" style="display: none;">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div id="status-text" style="font-size: 14px; color: #666; margin-top: 10px;"></div>
                </div>

                <!-- Stats (c√¥t√© droit) -->
                <div style="flex: 1;">
                    <div class="stats" style="grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="stat-item">
                            <div class="stat-number" id="stat-admin">0</div>
                            <div class="stat-label">Projets ADMIN</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-bpte">0</div>
                            <div class="stat-label">Op√©rations BPTE</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-matches">0</div>
                            <div class="stat-label">Correspondances</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-coords">0</div>
                            <div class="stat-label">Points GPS</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contr√¥les de la carte ferroviaire -->
        
        <div style="position: relative;">
            <div id="map"></div>
        </div>
        
        <!-- SECTION FILTRES SOUS LA CARTE -->
        <div class="section" id="filters-section" style="display: none; padding: 15px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                üîç Filtrer les projets
                <span id="filter-results" style="font-size: 14px; color: #666; font-weight: normal;"></span>
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: end;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">CEP (Admin):</label>
                    <select id="filter-cep" onchange="updateLigneOptions(); applyFilters();" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; background: white; font-size: 14px;">
                        <option value="">Tous les CEP</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">Ligne (BPTE):</label>
                    <select id="filter-ligne" onchange="applyFilters();" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; background: white; font-size: 14px;">
                        <option value="">Toutes les lignes</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="clearFilters()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;">
                        Effacer les filtres
                    </button>
                </div>
            </div>
        </div>

        <!-- Tableau des r√©sultats compact -->
        <div class="section" id="results-section" style="display: none; padding: 10px;">
            <h3 style="margin: 5px 0 10px 0; font-size: 16px;">üìä R√©sultats de l'analyse</h3>
            <div id="results-container"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let layers = {};
        let markers = [];
        
        // ========== FONCTIONS FIREBASE ==========
        
        // Sauvegarder les donn√©es ADMIN dans Firebase
        async function saveAdminDataToFirebase(adminData) {
            if (!window.firebaseDB || !adminData || adminData.length === 0) return;
            
            try {
                console.log('üíæ Sauvegarde des donn√©es ADMIN dans Firebase...');
                const batch = [];
                
                for (let i = 0; i < adminData.length; i++) {
                    const item = adminData[i];
                    if (item.F1) { // Si on a un code F
                        const docRef = doc(window.firebaseDB, 'admin_projects', item.F1);
                        batch.push(setDoc(docRef, {
                            ...item,
                            timestamp: new Date(),
                            source: 'admin_upload'
                        }));
                    }
                }
                
                await Promise.all(batch);
                console.log(`‚úÖ ${adminData.length} projets ADMIN sauvegard√©s dans Firebase`);
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde ADMIN:', error);
            }
        }
        
        // Sauvegarder les donn√©es BPTE dans Firebase
        async function saveBpteDataToFirebase(bpteData) {
            if (!window.firebaseDB || !bpteData || bpteData.length === 0) return;
            
            try {
                console.log('üíæ Sauvegarde des donn√©es BPTE dans Firebase...');
                const batch = [];
                
                for (let i = 0; i < bpteData.length; i++) {
                    const item = bpteData[i];
                    if (item.code_f) { // Si on a un code F
                        const docRef = doc(window.firebaseDB, 'bpte_projects', item.code_f);
                        batch.push(setDoc(docRef, {
                            ...item,
                            timestamp: new Date(),
                            source: 'bpte_upload'
                        }));
                    }
                }
                
                await Promise.all(batch);
                console.log(`‚úÖ ${bpteData.length} projets BPTE sauvegard√©s dans Firebase`);
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde BPTE:', error);
            }
        }
        
        // Charger les donn√©es ADMIN depuis Firebase
        async function loadAdminDataFromFirebase() {
            if (!window.firebaseDB) return [];
            
            try {
                console.log('üì• Chargement des donn√©es ADMIN depuis Firebase...');
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'admin_projects'));
                const data = [];
                
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`‚úÖ ${data.length} projets ADMIN charg√©s depuis Firebase`);
                return data;
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement ADMIN:', error);
                return [];
            }
        }
        
        // Charger les donn√©es BPTE depuis Firebase
        async function loadBpteDataFromFirebase() {
            if (!window.firebaseDB) return [];
            
            try {
                console.log('üì• Chargement des donn√©es BPTE depuis Firebase...');
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'bpte_projects'));
                const data = [];
                
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`‚úÖ ${data.length} projets BPTE charg√©s depuis Firebase`);
                return data;
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement BPTE:', error);
                return [];
            }
        }
        
        // Sauvegarder les donn√©es ferroviaires SNCF dans Firebase
        async function saveSNCFDataToFirebase() {
            if (!window.firebaseDB) return;
            
            try {
                console.log('üíæ Sauvegarde des donn√©es SNCF dans Firebase...');
                
                // Sauvegarder les gares
                const garesRef = doc(window.firebaseDB, 'sncf_data', 'gares');
                await setDoc(garesRef, {
                    data: garesDataEmbedded,
                    timestamp: new Date(),
                    source: 'embedded_data'
                });
                
                // Sauvegarder les passages √† niveau
                const pnRef = doc(window.firebaseDB, 'sncf_data', 'passages_niveau');
                await setDoc(pnRef, {
                    data: passagesNiveauDataEmbedded,
                    timestamp: new Date(),
                    source: 'embedded_data'
                });
                
                // Sauvegarder les quais
                const quaisRef = doc(window.firebaseDB, 'sncf_data', 'quais');
                await setDoc(quaisRef, {
                    data: quaisDataEmbedded,
                    timestamp: new Date(),
                    source: 'embedded_data'
                });
                
                console.log('‚úÖ Donn√©es SNCF sauvegard√©es dans Firebase');
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde SNCF:', error);
            }
        }
        
        // Fonction pour charger automatiquement les donn√©es depuis Firebase au d√©marrage
        async function loadDataFromFirebaseOnStart() {
            if (!window.firebaseDB) return;
            
            try {
                console.log('üöÄ Chargement automatique des donn√©es depuis Firebase...');
                
                // Charger les donn√©es projets
                const [adminFirebaseData, bpteFirebaseData] = await Promise.all([
                    loadAdminDataFromFirebase(),
                    loadBpteDataFromFirebase()
                ]);
                
                if (adminFirebaseData.length > 0) {
                    adminData = adminFirebaseData;
                    rawAdminData = adminFirebaseData;
                    console.log(`üìä ${adminData.length} projets ADMIN charg√©s depuis Firebase`);
                }
                
                if (bpteFirebaseData.length > 0) {
                    bpteData = bpteFirebaseData;
                    rawBpteData = bpteFirebaseData;
                    console.log(`üìä ${bpteData.length} projets BPTE charg√©s depuis Firebase`);
                }
                
                // Si on a des donn√©es, lancer l'analyse
                if (adminData.length > 0 && bpteData.length > 0) {
                    updateStats();
                    await findCorrespondances();
                    addMarkersToMap();
                    showResults();
                    initializeFilters();
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement automatique:', error);
            }
        }

        // Variables pour les donn√©es
        let adminData = [];
        let bpteData = [];
        let correspondances = [];
        let correspondancesFiltrees = [];
        let rawAdminData = [];
        let rawBpteData = [];
        let sncfLignesData = null;
        let sncfDataLoading = false;
        
        // Donn√©es locales SNCF int√©gr√©es (base √©tendue comme GEOCEPV2)
        const garesDataEmbedded = [
            {"code_uic":"87611111","libelle":"Toulouse-Matabiau","code_ligne":"640000","pk":"000+000","x_wgs84":1.4442,"y_wgs84":43.6045},
            {"code_uic":"87784256","libelle":"Perpignan","code_ligne":"650000","pk":"189+123","x_wgs84":2.8954,"y_wgs84":42.6977},
            {"code_uic":"87751008","libelle":"Marseille-St-Charles","code_ligne":"830000","pk":"862+583","x_wgs84":5.3809,"y_wgs84":43.3029},
            {"code_uic":"87725002","libelle":"Lyon-Part-Dieu","code_ligne":"830000","pk":"511+560","x_wgs84":4.8607,"y_wgs84":45.7597},
            {"code_uic":"87673004","libelle":"Bayonne","code_ligne":"640000","pk":"309+267","x_wgs84":-1.4759,"y_wgs84":43.4883},
            {"code_uic":"87671008","libelle":"Tarbes","code_ligne":"652000","pk":"190+123","x_wgs84":0.0781,"y_wgs84":43.2317},
            {"code_uic":"87613000","libelle":"Rodez","code_ligne":"738000","pk":"158+456","x_wgs84":2.5755,"y_wgs84":44.3505},
            {"code_uic":"87615005","libelle":"Albi","code_ligne":"736000","pk":"413+323","x_wgs84":2.1378,"y_wgs84":43.9223},
            {"code_uic":"87775288","libelle":"Al√®s","code_ligne":"805000","pk":"765+108","x_wgs84":4.0810,"y_wgs84":44.1316},
            {"code_uic":"87781260","libelle":"Vias","code_ligne":"640000","pk":"448+887","x_wgs84":3.4260,"y_wgs84":43.3157},
            {"code_uic":"87671339","libelle":"Lourdes","code_ligne":"650000","pk":"176+863","x_wgs84":-0.0420,"y_wgs84":43.1006},
            {"code_uic":"87784264","libelle":"Port-Vendres","code_ligne":"677000","pk":"497+260","x_wgs84":3.1027,"y_wgs84":42.5134},
            {"code_uic":"87594085","libelle":"Brive-la-Gaillarde","code_ligne":"590000","pk":"495+000","x_wgs84":1.5342,"y_wgs84":45.1600},
            {"code_uic":"87594002","libelle":"Tulle","code_ligne":"590000","pk":"534+000","x_wgs84":1.7674,"y_wgs84":45.2663},
            {"code_uic":"87754002","libelle":"Montpellier","code_ligne":"640000","pk":"379+000","x_wgs84":3.8767,"y_wgs84":43.6043},
            {"code_uic":"87781435","libelle":"N√Æmes","code_ligne":"800000","pk":"714+000","x_wgs84":4.3601,"y_wgs84":43.8367},
            {"code_uic":"87613109","libelle":"Millau","code_ligne":"738000","pk":"158+000","x_wgs84":3.0778,"y_wgs84":44.0937},
            {"code_uic":"87671107","libelle":"Pau","code_ligne":"650000","pk":"126+000","x_wgs84":-0.3692,"y_wgs84":43.2951},
            {"code_uic":"87611046","libelle":"Agen","code_ligne":"640000","pk":"115+000","x_wgs84":0.6167,"y_wgs84":44.2028},
            {"code_uic":"87594200","libelle":"P√©rigueux","code_ligne":"500000","pk":"456+000","x_wgs84":0.7211,"y_wgs84":45.1845},
            {"code_uic":"87681478","libelle":"Bordeaux-St-Jean","code_ligne":"580000","pk":"000+000","x_wgs84":-0.5592,"y_wgs84":44.8259},
            {"code_uic":"87581009","libelle":"Angoul√™me","code_ligne":"571000","pk":"425+000","x_wgs84":0.1600,"y_wgs84":45.6500},
            {"code_uic":"87597005","libelle":"Limoges-B√©n√©dictins","code_ligne":"590000","pk":"385+000","x_wgs84":1.2667,"y_wgs84":45.8354},
            {"code_uic":"87671024","libelle":"Oloron-Sainte-Marie","code_ligne":"653000","pk":"075+000","x_wgs84":-0.6111,"y_wgs84":43.1944},
            {"code_uic":"87671040","libelle":"Orthez","code_ligne":"650000","pk":"149+000","x_wgs84":-0.7667,"y_wgs84":43.4833},
            {"code_uic":"87681460","libelle":"Dax","code_ligne":"647000","pk":"184+000","x_wgs84":-1.0556,"y_wgs84":43.7056},
            {"code_uic":"87681007","libelle":"Mont-de-Marsan","code_ligne":"647000","pk":"125+000","x_wgs84":-0.5000,"y_wgs84":43.8917},
            {"code_uic":"87681502","libelle":"Morcenx","code_ligne":"647000","pk":"156+000","x_wgs84":-0.9111,"y_wgs84":44.0417},
            {"code_uic":"87671107","libelle":"Hendaye","code_ligne":"630000","pk":"198+000","x_wgs84":-1.7747,"y_wgs84":43.3569},
            {"code_uic":"87681510","libelle":"Biarritz","code_ligne":"630000","pk":"185+000","x_wgs84":-1.5589,"y_wgs84":43.4832},
            {"code_uic":"87594176","libelle":"Cahors","code_ligne":"521000","pk":"567+000","x_wgs84":1.4417,"y_wgs84":44.4472},
            {"code_uic":"87594168","libelle":"Montauban","code_ligne":"521000","pk":"650+000","x_wgs84":1.3567,"y_wgs84":44.0150},
            {"code_uic":"87681213","libelle":"Marmande","code_ligne":"640000","pk":"085+000","x_wgs84":0.1667,"y_wgs84":44.5000},
            {"code_uic":"87681239","libelle":"Tonneins","code_ligne":"640000","pk":"072+000","x_wgs84":0.3083,"y_wgs84":44.3889},
            {"code_uic":"87681221","libelle":"N√©rac","code_ligne":"646000","pk":"025+000","x_wgs84":0.3400,"y_wgs84":44.1350},
            {"code_uic":"87681288","libelle":"Condom","code_ligne":"646000","pk":"055+000","x_wgs84":0.3739,"y_wgs84":43.9550}
        ];

        const passagesNiveauDataEmbedded = [
            // Donn√©es r√©elles des PN d'Occitanie int√©gr√©es depuis pn_occitanie.geojson
            {"id":"PN-Occ1","libelle":"Passage √† niveau Seysses","nom":"Passage √† niveau Seysses","code_ligne":"XXXX","pk":"123+456","departement":"Haute-Garonne","type_pn":"PN public sans barri√®res","x_wgs84":1.427,"y_wgs84":43.597},
            {"id":"PN-Occ2","libelle":"PN pr√®s de Toulouse","nom":"PN pr√®s de Toulouse","code_ligne":"YYYY","pk":"98+765","departement":"Haute-Garonne","type_pn":"PN public avec barri√®res","x_wgs84":1.450,"y_wgs84":43.610},
            {"id":"PN-Occ3","libelle":"PN Ax-les-Thermes","nom":"PN Ax-les-Thermes","code_ligne":"ZZZZ","pk":"200+000","departement":"Ari√®ge","type_pn":"PN public avec SAL","x_wgs84":1.733,"y_wgs84":42.726},
            {"id":"PN-Occ4","libelle":"PN Montauban sud","nom":"PN Montauban sud","code_ligne":"WWWW","pk":"50+123","departement":"Tarn-et-Garonne","type_pn":"PN avec barri√®res automatiques","x_wgs84":1.353,"y_wgs84":44.017},
            {"id":"PN-Occ5","libelle":"PN Narbonne est","nom":"PN Narbonne est","code_ligne":"VVVV","pk":"75+432","departement":"Aude","type_pn":"PN public sans SAL","x_wgs84":3.110,"y_wgs84":43.185}
        ];

        const quaisDataEmbedded = [
            {"gare":"87611111","quai":"A","x_wgs84":1.4443,"y_wgs84":43.6046},
            {"gare":"87611111","quai":"B","x_wgs84":1.4441,"y_wgs84":43.6044},
            {"gare":"87784256","quai":"1","x_wgs84":2.8955,"y_wgs84":42.6978},
            {"gare":"87784256","quai":"2","x_wgs84":2.8953,"y_wgs84":42.6976},
            {"gare":"87754002","quai":"A","x_wgs84":3.8768,"y_wgs84":43.6044},
            {"gare":"87754002","quai":"B","x_wgs84":3.8766,"y_wgs84":43.6042},
            {"gare":"87781435","quai":"1","x_wgs84":4.3602,"y_wgs84":43.8368},
            {"gare":"87781435","quai":"2","x_wgs84":4.3600,"y_wgs84":43.8366},
            {"gare":"87671107","quai":"A","x_wgs84":-0.3693,"y_wgs84":43.2952},
            {"gare":"87671107","quai":"B","x_wgs84":-0.3691,"y_wgs84":43.2950},
            {"gare":"87611046","quai":"1","x_wgs84":0.6168,"y_wgs84":44.2029},
            {"gare":"87611046","quai":"2","x_wgs84":0.6166,"y_wgs84":44.2027}
        ];

        // Donn√©es locales SNCF pour la g√©olocalisation
        let garesData = [...garesDataEmbedded];
        let passagesNiveauData = [...passagesNiveauDataEmbedded];
        let quaisData = [...quaisDataEmbedded];
        let coordinatesCache = new Map();
        let sncfDataLoaded = true; // Donn√©es int√©gr√©es directement
        let userLocation = null;
        let geolocalizationActive = false;
        let lignesInconnuesWarned = new Set(); // Pour √©viter de r√©p√©ter les warnings
        let geoJsonData = null; // Donn√©es GeoJSON ferroviaires d'Occitanie
        let lignesGeoJson = new Map(); // Cache des lignes avec coordonn√©es pr√©cises
        let excelOnlyMode = true; // Mode Excel uniquement par d√©faut
        
        // Initialisation de la carte ferroviaire
        function initRailwayMap() {
            console.log('üöÑ Initialisation de la carte ferroviaire...');
            
            // V√©rifier que XLSX est charg√©
            if (typeof XLSX === 'undefined') {
                console.error('‚ùå ATTENTION: Biblioth√®que XLSX non charg√©e');
                alert('Erreur: Biblioth√®que XLSX non charg√©e. Rechargez la page.');
                return;
            } else {
                console.log('‚úÖ Biblioth√®que XLSX charg√©e correctement');
            }
            
            // Carte centr√©e sur Toulouse
            map = L.map('map').setView([43.604, 1.444], 11);
            
            // Couche de base OpenStreetMap √©pur√©e
            const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            });
            
            // COUCHES FERROVIAIRES OpenRailwayMap
            
            // 1. Infrastructure ferroviaire (voies, gares, etc.)
            layers.infrastructure = L.tileLayer('https://tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
                attribution: '¬© OpenRailwayMap contributors',
                opacity: 1.0
            });
            
            // 2. Signalisation
            layers.signaling = L.tileLayer('https://tiles.openrailwaymap.org/signals/{z}/{x}/{y}.png', {
                attribution: '¬© OpenRailwayMap contributors',
                opacity: 0.8
            });
            
            // 3. √âlectrification
            layers.electrification = L.tileLayer('https://tiles.openrailwaymap.org/electrified/{z}/{x}/{y}.png', {
                attribution: '¬© OpenRailwayMap contributors',
                opacity: 0.7
            });
            
            // 4. Limitations de vitesse
            layers.speed = L.tileLayer('https://tiles.openrailwaymap.org/maxspeed/{z}/{x}/{y}.png', {
                attribution: '¬© OpenRailwayMap contributors',
                opacity: 0.6
            });
            
            // 5. √âcartement des voies
            layers.gauge = L.tileLayer('https://tiles.openrailwaymap.org/gauge/{z}/{x}/{y}.png', {
                attribution: '¬© OpenRailwayMap contributors',
                opacity: 0.5
            });
            
            // Ajouter les couches par d√©faut
            baseLayer.addTo(map);
            layers.infrastructure.addTo(map);
            
            // Ajouter les contr√¥les personnalis√©s
            addCustomControls();
            
            // Charger les donn√©es SNCF officielles
            loadSNCFData();
            
            // Configurer les √©v√©nements de fichiers
            setupFileHandlers();
            
            console.log('üöÑ Carte ferroviaire initialis√©e avec OpenRailwayMap');
        }
        
        // Ajouter les contr√¥les personnalis√©s
        function addCustomControls() {
            // Barre de recherche g√©olocalisation
            const searchControl = L.control({ position: 'topright' });
            searchControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'search-control');
                div.style.cssText = `
                    background: white; padding: 8px; border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-bottom: 10px;
                `;
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="text" id="search-input" placeholder="Adresse, GPS (lat,lng) ou PK (ligne+km)" 
                               style="border: 1px solid #ddd; padding: 6px; border-radius: 4px; width: 220px; font-size: 12px;"
                               onkeypress="if(event.key==='Enter') searchLocation()">
                        <button onclick="searchLocation()" 
                                style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"
                                title="Rechercher">
                            üîç
                        </button>
                    </div>
                `;
                
                // Emp√™cher la propagation des √©v√©nements de la carte
                L.DomEvent.disableClickPropagation(div);
                L.DomEvent.disableScrollPropagation(div);
                
                return div;
            };
            searchControl.addTo(map);
            
            // Contr√¥les des couches ferroviaires personnalis√©s
            const layerControl = L.control({ position: 'topright' });
            layerControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'layer-control');
                div.style.cssText = `
                    background: white; padding: 10px; border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-bottom: 10px;
                    min-width: 180px;
                `;
                div.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: bold; color: #003C71; font-size: 12px;">
                        üöÇ Couches Ferroviaires
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px; font-size: 11px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="layer-infrastructure" checked onchange="toggleLayer('infrastructure')"> 
                            <span style="margin-left: 6px;">üõ§Ô∏è Infrastructure</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="layer-signaling" onchange="toggleLayer('signaling')"> 
                            <span style="margin-left: 6px;">üö¶ Signalisation</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="layer-electrification" onchange="toggleLayer('electrification')"> 
                            <span style="margin-left: 6px;">‚ö° √âlectrification</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="layer-speed" onchange="toggleLayer('speed')"> 
                            <span style="margin-left: 6px;">üèÉ Vitesse</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="layer-gauge" onchange="toggleLayer('gauge')"> 
                            <span style="margin-left: 6px;">üìè √âcartement</span>
                        </label>
                    </div>
                    <hr style="margin: 10px 0; border: 1px solid #eee;">
                    <button onclick="toggleAllLayers(false)" 
                            style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 11px;">
                        ‚ùå D√©sactiver tout
                    </button>
                    <button onclick="toggleAllLayers(true)" 
                            style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 4px; font-size: 11px;">
                        ‚úÖ Activer tout
                    </button>
                `;
                
                // Emp√™cher la propagation des √©v√©nements
                L.DomEvent.disableClickPropagation(div);
                L.DomEvent.disableScrollPropagation(div);
                
                return div;
            };
            layerControl.addTo(map);
            
            // ========== CONTR√îLES SUPPL√âMENTAIRES DE LA CARTE ==========
            
            // 1. Contr√¥le Plein √âcran
            const fullscreenControl = L.control({ position: 'topleft' });
            fullscreenControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');
                const button = L.DomUtil.create('a', 'map-control-btn', div);
                button.innerHTML = '‚õ∂';
                button.href = '#';
                button.title = 'Plein √©cran / Fen√™tr√©';
                
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    toggleFullscreen();
                });
                
                L.DomEvent.disableClickPropagation(div);
                return div;
            };
            fullscreenControl.addTo(map);
            
            // 2. Contr√¥le Zoom sur Toulouse
            const homeControl = L.control({ position: 'topleft' });
            homeControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');
                const button = L.DomUtil.create('a', 'map-control-btn', div);
                button.innerHTML = 'üè†';
                button.href = '#';
                button.title = 'Centrer sur Toulouse';
                
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    map.setView([43.604, 1.444], 11);
                });
                
                L.DomEvent.disableClickPropagation(div);
                return div;
            };
            homeControl.addTo(map);
            
            // 3. Contr√¥le d'information
            const infoControl = L.control({ position: 'bottomright' });
            infoControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control-attribution leaflet-control');
                div.style.background = 'rgba(255,255,255,0.9)';
                div.style.padding = '8px';
                div.style.borderRadius = '4px';
                div.style.fontSize = '12px';
                div.innerHTML = `
                    <strong>üöÑ GEOESTIM</strong><br>
                    <span id="map-info">Projets: ${correspondances.length || 0} | Vue: Toulouse</span>
                `;
                return div;
            };
            infoControl.addTo(map);
            
            // 4. Contr√¥le de mesure avanc√© avec couleurs et gomme
            const measureControl = L.control({ position: 'topleft' });
            measureControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');
                
                // Bouton principal de mesure
                const measureBtn = L.DomUtil.create('a', 'map-control-btn', div);
                measureBtn.innerHTML = 'üìè';
                measureBtn.href = '#';
                measureBtn.title = 'Outils de mesure';
                measureBtn.id = 'measure-main-btn';
                
                // Panneau d'outils de mesure
                const toolPanel = L.DomUtil.create('div', 'measure-tool-panel', div);
                toolPanel.style.cssText = `
                    display: none;
                    position: absolute;
                    top: 0;
                    left: 32px;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    padding: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    min-width: 200px;
                    z-index: 1000;
                `;
                
                toolPanel.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>üé® Couleur du trait:</strong><br>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <div class="color-btn" data-color="red" style="width: 20px; height: 20px; background: red; border: 2px solid #000; cursor: pointer; border-radius: 3px;" title="Rouge"></div>
                            <div class="color-btn" data-color="blue" style="width: 20px; height: 20px; background: blue; border: 1px solid #ccc; cursor: pointer; border-radius: 3px;" title="Bleu"></div>
                            <div class="color-btn" data-color="green" style="width: 20px; height: 20px; background: green; border: 1px solid #ccc; cursor: pointer; border-radius: 3px;" title="Vert"></div>
                            <div class="color-btn" data-color="orange" style="width: 20px; height: 20px; background: orange; border: 1px solid #ccc; cursor: pointer; border-radius: 3px;" title="Orange"></div>
                            <div class="color-btn" data-color="purple" style="width: 20px; height: 20px; background: purple; border: 1px solid #ccc; cursor: pointer; border-radius: 3px;" title="Violet"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üìè Actions:</strong><br>
                        <button id="start-measure" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">Mesurer</button>
                        <button id="stop-measure" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">Arr√™ter</button>
                    </div>
                    <div>
                        <button id="clear-measures" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">üóëÔ∏è Tout effacer</button>
                    </div>
                `;
                
                let measuring = false;
                let currentColor = 'red';
                let measureLines = []; // Tableau pour stocker toutes les lignes
                let currentLine = null;
                let currentPoints = [];
                
                // Gestion du clic sur le bouton principal
                L.DomEvent.on(measureBtn, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    const isVisible = toolPanel.style.display === 'block';
                    toolPanel.style.display = isVisible ? 'none' : 'block';
                });
                
                // Gestion des couleurs
                const colorBtns = toolPanel.querySelectorAll('.color-btn');
                colorBtns.forEach(btn => {
                    L.DomEvent.on(btn, 'click', function(e) {
                        L.DomEvent.preventDefault(e);
                        // Reset borders
                        colorBtns.forEach(b => b.style.border = '1px solid #ccc');
                        // Highlight selected
                        this.style.border = '2px solid #000';
                        currentColor = this.dataset.color;
                    });
                });
                
                // Bouton commencer mesure
                L.DomEvent.on(toolPanel.querySelector('#start-measure'), 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    startMeasuring();
                });
                
                // Bouton arr√™ter mesure
                L.DomEvent.on(toolPanel.querySelector('#stop-measure'), 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    stopMeasuring();
                });
                
                // Bouton effacer tout
                L.DomEvent.on(toolPanel.querySelector('#clear-measures'), 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    clearAllMeasures();
                });
                
                function startMeasuring() {
                    if (measuring) return;
                    
                    measuring = true;
                    measureBtn.style.background = '#007cff';
                    measureBtn.style.color = 'white';
                    map.getContainer().style.cursor = 'crosshair';
                    currentPoints = [];
                    
                    map.on('click', onMapClick);
                    map.on('dblclick', finishCurrentLine);
                }
                
                function stopMeasuring() {
                    measuring = false;
                    measureBtn.style.background = 'white';
                    measureBtn.style.color = 'black';
                    map.getContainer().style.cursor = '';
                    map.off('click', onMapClick);
                    map.off('dblclick', finishCurrentLine);
                    
                    if (currentLine && currentPoints.length > 1) {
                        finishCurrentLine();
                    }
                }
                
                function onMapClick(e) {
                    if (!measuring) return;
                    
                    currentPoints.push(e.latlng);
                    
                    if (currentPoints.length === 1) {
                        currentLine = L.polyline(currentPoints, {
                            color: currentColor, 
                            weight: 4,
                            opacity: 0.8
                        }).addTo(map);
                    } else {
                        currentLine.setLatLngs(currentPoints);
                        updateDistance();
                    }
                }
                
                function updateDistance() {
                    if (currentLine && currentPoints.length > 1) {
                        const distance = calculateDistance(currentPoints);
                        currentLine.bindPopup(`
                            <div style="text-align: center;">
                                <strong>üìè Distance: ${distance.toFixed(2)} km</strong><br>
                                <small style="color: ${currentColor};">‚óè Trait ${currentColor}</small>
                            </div>
                        `);
                    }
                }
                
                function finishCurrentLine() {
                    if (currentLine && currentPoints.length > 1) {
                        measureLines.push(currentLine);
                        updateDistance();
                        currentLine.openPopup();
                    }
                    currentLine = null;
                    currentPoints = [];
                }
                
                function clearAllMeasures() {
                    measureLines.forEach(line => {
                        if (map.hasLayer(line)) {
                            map.removeLayer(line);
                        }
                    });
                    
                    if (currentLine && map.hasLayer(currentLine)) {
                        map.removeLayer(currentLine);
                    }
                    
                    measureLines = [];
                    currentLine = null;
                    currentPoints = [];
                    
                    if (measuring) {
                        stopMeasuring();
                    }
                }
                
                function calculateDistance(points) {
                    let total = 0;
                    for (let i = 1; i < points.length; i++) {
                        total += points[i-1].distanceTo(points[i]);
                    }
                    return total / 1000; // Convertir en km
                }
                
                // Fermer le panneau si on clique ailleurs
                L.DomEvent.on(document, 'click', function(e) {
                    if (!div.contains(e.target)) {
                        toolPanel.style.display = 'none';
                    }
                });
                
                L.DomEvent.disableClickPropagation(div);
                L.DomEvent.disableClickPropagation(toolPanel);
                return div;
            };
            measureControl.addTo(map);
            
            // Fonction plein √©cran
            function toggleFullscreen() {
                const mapContainer = document.getElementById('map');
                if (mapContainer.classList.contains('fullscreen-active')) {
                    mapContainer.classList.remove('fullscreen-active');
                    document.body.style.overflow = '';
                } else {
                    mapContainer.classList.add('fullscreen-active');
                    document.body.style.overflow = 'hidden';
                }
                
                // Redimensionner la carte apr√®s changement
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
            
            // √âcouter la touche Escape pour sortir du plein √©cran
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const mapContainer = document.getElementById('map');
                    if (mapContainer.classList.contains('fullscreen-active')) {
                        mapContainer.classList.remove('fullscreen-active');
                        document.body.style.overflow = '';
                        setTimeout(() => map.invalidateSize(), 100);
                    }
                }
            });
        }
        
        // ========== FONCTION MISE √Ä JOUR INFORMATIONS CARTE ==========
        function updateMapInfo() {
            const infoElement = document.getElementById('map-info');
            if (infoElement) {
                // Utiliser les marqueurs actuellement affich√©s ou toutes les correspondances
                const displayedCount = filteredMarkers.length > 0 ? filteredMarkers.length : (correspondances ? correspondances.length : 0);
                const totalCount = allCorrespondances.length > 0 ? allCorrespondances.length : (correspondances ? correspondances.length : 0);
                const adminCount = adminData && adminData.allColumns ? Object.keys(adminData.allColumns).length : 0;
                const bpteCount = bpteData && bpteData.rawData ? Object.keys(bpteData.rawData).length : 0;
                
                infoElement.innerHTML = `
                    Projets: ${displayedCount}${totalCount !== displayedCount ? `/${totalCount}` : ''} | 
                    Admin: ${adminCount} | 
                    BPTE: ${bpteCount} | 
                    Vue: Toulouse
                `;
            }
        }
        
        // Fonction de recherche g√©olocalisation avanc√©e (V2)
        function searchLocation() {
            const input = document.getElementById('search-input');
            const query = input.value.trim();
            
            if (!query) {
                alert('Veuillez entrer une adresse, des coordonn√©es GPS ou un PK ferroviaire');
                return;
            }

            // Appeler la fonction de recherche avanc√©e
            searchLocationV2(query);
            input.value = '';
        }

        // Fonction de recherche intelligente avec d√©tection de coordonn√©es GPS (version wrapper)
        async function searchLocationV2(searchInput) {
            const query = searchInput.trim();
            if (!query) return;

            // D√âTECTION 1: Coordonn√©es GPS directes (latitude,longitude)
            const coordsPattern = /^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/;
            const coordsMatch = query.match(coordsPattern);
            
            if (coordsMatch) {
                const lat = parseFloat(coordsMatch[1]);
                const lng = parseFloat(coordsMatch[2]);
                
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    // Pas de zoom automatique - seulement placement du marqueur
                    
                    // Supprimer le marqueur pr√©c√©dent s'il existe
                    if (window.searchMarker) {
                        map.removeLayer(window.searchMarker);
                    }
                    
                    window.searchMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup(`üìç Coordonn√©es GPS: ${lat}, ${lng}`).openPopup();
                    return;
                }
            }

            // D√âTECTION 2: Format PK ferroviaire (ligne PK)
            const pkPattern = /(?:L?(\d+)[\s+]*(\d+(?:[+.,]\d+)?))|((\d+)[\s]*[+][\s]*(\d+(?:[.,]\d+)?))/;
            const pkMatch = query.match(pkPattern);
            
            if (pkMatch) {
                const ligne = (pkMatch[1] || pkMatch[4]) + '000'; // Convertir en format 6 chiffres
                const pk = (pkMatch[2] || pkMatch[5]).replace(',', '.');
                
                console.log(`üîç Recherche PK: L${ligne} PK ${pk}`);
                
                try {
                    const coords = obtenirCoordonneesPK(ligne, pk, pk);
                    if (coords && coords.lat && coords.lng) {
                        // Pas de zoom automatique - seulement placement du marqueur
                        
                        // Supprimer le marqueur pr√©c√©dent s'il existe
                        if (window.searchMarker) {
                            map.removeLayer(window.searchMarker);
                        }
                        
                        window.searchMarker = L.marker([coords.lat, coords.lng], {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map).bindPopup(`üöÇ L${ligne} PK ${pk}<br>üìç ${coords.source}<br>Lat: ${coords.lat.toFixed(6)}<br>Lng: ${coords.lng.toFixed(6)}`).openPopup();
                        return;
                    } else {
                        alert(`‚ùå PK L${ligne} ${pk} non trouv√© dans la base de donn√©es`);
                        return;
                    }
                } catch (error) {
                    console.error('Erreur recherche PK:', error);
                    alert(`‚ùå Erreur lors de la recherche du PK L${ligne} ${pk}`);
                    return;
                }
            }

            // D√âTECTION 3: Passage √† Niveau (PN)
            // Patterns accept√©s: "PN Seysses", "PN Toulouse", "PN-Occ1", "Passage niveau Seysses", etc.
            const pnPatterns = [
                /(?:PN|Passage.*niveau)\s*([A-Za-z\-\s]+)/i,  // PN + nom
                /(PN-Occ\d+)/i,                               // ID direct
                /PN\s*(\d+)/i                                 // PN + num√©ro (ancien format)
            ];
            
            let pnMatch = null;
            let pnSearchTerm = null;
            
            for (const pattern of pnPatterns) {
                pnMatch = query.match(pattern);
                if (pnMatch) {
                    pnSearchTerm = pnMatch[1].trim();
                    break;
                }
            }
            
            if (pnMatch && pnSearchTerm) {
                console.log(`üîç Recherche PN: "${pnSearchTerm}"`);
                
                // Rechercher dans les donn√©es PN (par nom, libelle, ou ID)
                const pnResult = passagesNiveauData.find(pn => {
                    if (!pn) return false;
                    
                    const searchLower = pnSearchTerm.toLowerCase();
                    
                    // Recherche par ID direct
                    if (pn.id && pn.id.toLowerCase() === searchLower) return true;
                    
                    // Recherche par nom/libelle
                    if (pn.nom && pn.nom.toLowerCase().includes(searchLower)) return true;
                    if (pn.libelle && pn.libelle.toLowerCase().includes(searchLower)) return true;
                    
                    // Recherche par mots-cl√©s dans le nom
                    const keywords = searchLower.split(/\s+/);
                    return keywords.some(keyword => {
                        if (keyword.length < 3) return false; // Ignore les mots trop courts
                        return (pn.nom && pn.nom.toLowerCase().includes(keyword)) ||
                               (pn.libelle && pn.libelle.toLowerCase().includes(keyword));
                    });
                });
                
                if (pnResult && pnResult.x_wgs84 && pnResult.y_wgs84) {
                    // Pas de zoom automatique - seulement placement du marqueur
                    
                    // Supprimer le marqueur pr√©c√©dent s'il existe
                    if (window.searchMarker) {
                        map.removeLayer(window.searchMarker);
                    }
                    
                    window.searchMarker = L.marker([pnResult.y_wgs84, pnResult.x_wgs84], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup(`üöß ${pnResult.nom || pnResult.libelle}<br>üìç ${pnResult.departement || 'N/A'}<br>üõ§Ô∏è ${pnResult.type_pn || 'Type inconnu'}<br>üìç Ligne: ${pnResult.code_ligne}<br>PK: ${pnResult.pk}<br>Lat: ${pnResult.y_wgs84.toFixed(6)}<br>Lng: ${pnResult.x_wgs84.toFixed(6)}`).openPopup();
                    return;
                } else {
                    alert(`‚ùå PN "${pnSearchTerm}" non trouv√© dans la base de donn√©es.\n\nExemples disponibles:\n‚Ä¢ PN Seysses\n‚Ä¢ PN Toulouse\n‚Ä¢ PN Montauban\n‚Ä¢ PN-Occ1`);
                    return;
                }
            }

            // D√âTECTION 4: Recherche classique par adresse (Nominatim)
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=fr&addressdetails=1&extratags=1`);
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const result = results[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    // Pas de zoom automatique - seulement placement du marqueur
                    
                    // Supprimer le marqueur pr√©c√©dent s'il existe
                    if (window.searchMarker) {
                        map.removeLayer(window.searchMarker);
                    }
                    
                    window.searchMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup(`üìç ${result.display_name}`).openPopup();
                } else {
                    alert('‚ö†Ô∏è Lieu non trouv√©.\n\nFormats support√©s:\n‚Ä¢ Coordonn√©es GPS: 43.6045,1.4442\n‚Ä¢ PK ferroviaire: 655000 42.5\n‚Ä¢ Passage √† niveau: PN Seysses, PN Toulouse, PN-Occ1\n‚Ä¢ Adresse: Toulouse Matabiau');
                }
            } catch (error) {
                console.error('Erreur g√©ocodage:', error);
                alert('‚ùå Erreur de connexion pour la recherche d\'adresse');
            }
        }
        
        // Fonction pour activer/d√©sactiver toutes les couches
        function toggleAllLayers(activate) {
            const layerNames = ['infrastructure', 'signaling', 'electrification', 'speed', 'gauge'];
            
            layerNames.forEach(layerName => {
                const checkbox = document.getElementById(`layer-${layerName}`);
                if (checkbox) {
                    checkbox.checked = activate;
                    
                    if (activate) {
                        if (!map.hasLayer(layers[layerName])) {
                            layers[layerName].addTo(map);
                        }
                    } else {
                        if (map.hasLayer(layers[layerName])) {
                            map.removeLayer(layers[layerName]);
                        }
                    }
                }
            });
        }

        // Basculer les couches ferroviaires
        function toggleLayer(layerName) {
            const checkbox = document.getElementById(`layer-${layerName}`);
            
            if (checkbox && checkbox.checked) {
                if (!map.hasLayer(layers[layerName])) {
                    layers[layerName].addTo(map);
                }
            } else {
                if (map.hasLayer(layers[layerName])) {
                    map.removeLayer(layers[layerName]);
                }
            }
        }
        
        // ========== SYST√àME DE G√âOLOCALISATION AVANC√â (inspir√© GEOCEPV2) ==========
        
        // Recherche de coordonn√©es dans les donn√©es locales int√©gr√©es
        function findCoordinatesInLocalData(ligne, pk) {
            const ligneFormatted = ligne.toString().padStart(6, '0');
            const pkValue = parseFloat(pk.toString().replace('+', '.'));
            
            // Chercher dans les gares
            const gareMatch = garesData.find(gare => {
                if (!gare.code_ligne || !gare.pk) return false;
                const gareCodeLigne = gare.code_ligne.toString().padStart(6, '0');
                const garePk = parseFloat(gare.pk.toString().replace('+', '.'));
                
                return gareCodeLigne === ligneFormatted && Math.abs(garePk - pkValue) < 5; // Tol√©rance de 5 km
            });
            
            if (gareMatch && gareMatch.x_wgs84 && gareMatch.y_wgs84) {
                return {
                    lat: gareMatch.y_wgs84,
                    lng: gareMatch.x_wgs84,
                    source: `Gare-${gareMatch.libelle || 'Inconnue'}-PK${pk}`,
                    detail: gareMatch
                };
            }
            
            // Chercher dans les passages √† niveau
            const pnMatch = passagesNiveauData.find(pn => {
                if (!pn.code_ligne || !pn.pk) return false;
                const pnCodeLigne = pn.code_ligne.toString().padStart(6, '0');
                const pnPk = parseFloat(pn.pk.toString().replace('+', '.'));
                
                return pnCodeLigne === ligneFormatted && Math.abs(pnPk - pkValue) < 2; // Tol√©rance de 2 km
            });
            
            if (pnMatch && pnMatch.x_wgs84 && pnMatch.y_wgs84) {
                return {
                    lat: pnMatch.y_wgs84,
                    lng: pnMatch.x_wgs84,
                    source: `PN-${pnMatch.libelle || 'Inconnu'}-PK${pk}`,
                    detail: pnMatch
                };
            }
            
            // Interpolation bas√©e sur plusieurs points de la ligne
            const lignePoints = [
                ...garesData.filter(g => g.code_ligne && g.code_ligne.toString().padStart(6, '0') === ligneFormatted),
                ...passagesNiveauData.filter(p => p.code_ligne && p.code_ligne.toString().padStart(6, '0') === ligneFormatted)
            ].filter(point => point.pk && point.x_wgs84 && point.y_wgs84)
             .map(point => ({
               pk: parseFloat(point.pk.toString().replace('+', '.')),
               lat: point.y_wgs84,
               lng: point.x_wgs84,
               libelle: point.libelle
             }))
             .sort((a, b) => a.pk - b.pk);
            
            if (lignePoints.length >= 2) {
                // Trouver les deux points les plus proches pour interpoler
                let pointAvant = null;
                let pointApres = null;
                
                for (let i = 0; i < lignePoints.length - 1; i++) {
                    if (lignePoints[i].pk <= pkValue && lignePoints[i + 1].pk >= pkValue) {
                        pointAvant = lignePoints[i];
                        pointApres = lignePoints[i + 1];
                        break;
                    }
                }
                
                if (pointAvant && pointApres) {
                    const ratio = (pkValue - pointAvant.pk) / (pointApres.pk - pointAvant.pk);
                    const lat = pointAvant.lat + (pointApres.lat - pointAvant.lat) * ratio;
                    const lng = pointAvant.lng + (pointApres.lng - pointAvant.lng) * ratio;
                    
                    return {
                        lat: lat,
                        lng: lng,
                        source: `Interpolation-${pointAvant.libelle}-${pointApres.libelle}-PK${pk}`,
                        detail: { pointAvant, pointApres, ratio }
                    };
                }
            }
            
            return null;
        }

        // Calcul coordonn√©es GPS depuis PK avec cache et optimisations
        async function calculateCoordinatesFromPK(lignes, pkDebut, pkFin) {
            if (!lignes || !pkDebut) {
                return { lat: 43.6045, lng: 1.4442, source: 'D√©faut-Toulouse' };
            }
            
            const ligne = lignes.toString().split(',')[0].trim();
            const cacheKey = `${ligne}_${pkDebut}`;
            
            // V√©rifier le cache d'abord
            if (coordinatesCache.has(cacheKey)) {
                return coordinatesCache.get(cacheKey);
            }
            
            // PRIORIT√â 1: Chercher dans les donn√©es JSON locales
            const localCoords = findCoordinatesInLocalData(ligne, pkDebut);
            if (localCoords) {
                coordinatesCache.set(cacheKey, localCoords);
                return localCoords;
            }
            
            // PRIORIT√â 2: Coordonn√©es par d√©faut selon la r√©gion (plus intelligent)
            const defaultCoords = getDefaultCoordinatesByLine(ligne);
            coordinatesCache.set(cacheKey, defaultCoords);
            return defaultCoords;
        }

        // Fonction pour obtenir des coordonn√©es par d√©faut intelligentes
        function getDefaultCoordinatesByLine(ligne) {
            const ligneStr = ligne.toString().toLowerCase();
            
            // Coordonn√©es par r√©gion/ligne
            if (ligneStr.includes('toulouse') || ligneStr.includes('midi')) {
                return { lat: 43.6045, lng: 1.4442, source: 'D√©faut-Toulouse' };
            } else if (ligneStr.includes('montpellier') || ligneStr.includes('beziers')) {
                return { lat: 43.6119, lng: 3.8772, source: 'D√©faut-Montpellier' };
            } else if (ligneStr.includes('bordeaux') || ligneStr.includes('aquitaine')) {
                return { lat: 44.8378, lng: -0.5792, source: 'D√©faut-Bordeaux' };
            } else if (ligneStr.includes('bayonne') || ligneStr.includes('biarritz')) {
                return { lat: 43.4832, lng: -1.4897, source: 'D√©faut-Bayonne' };
            } else if (ligneStr.includes('nimes') || ligneStr.includes('gard')) {
                return { lat: 43.8367, lng: 4.3601, source: 'D√©faut-N√Æmes' };
            } else if (ligneStr.includes('perpignan') || ligneStr.includes('catalogne')) {
                return { lat: 42.6886, lng: 2.8948, source: 'D√©faut-Perpignan' };
            } else if (ligneStr.includes('clermont') || ligneStr.includes('auvergne')) {
                return { lat: 45.7772, lng: 3.0870, source: 'D√©faut-Clermont' };
            } else if (ligneStr.includes('limoges') || ligneStr.includes('limousin')) {
                return { lat: 45.8336, lng: 1.2611, source: 'D√©faut-Limoges' };
            } else if (ligneStr.includes('brive') || ligneStr.includes('correze')) {
                return { lat: 45.1590, lng: 1.5334, source: 'D√©faut-Brive' };
            }
            
            // Par d√©faut Toulouse (centre de la r√©gion)
            return { lat: 43.6045, lng: 1.4442, source: 'D√©faut-Toulouse' };
        }
        
        // G√©olocalisation GPS de l'utilisateur (EXACT V2 adapt√© Leaflet)
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå G√©olocalisation non support√©e par votre navigateur');
                return;
            }

            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #007bff; color: white; padding: 20px; border-radius: 10px;
                z-index: 10000; font-size: 16px; text-align: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            `;
            statusDiv.innerHTML = 'üåç Localisation en cours...<br><small>Autorisez l\'acc√®s √† votre position</small>';
            document.body.appendChild(statusDiv);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.body.removeChild(statusDiv);
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    userLocation = { lat, lng, accuracy };
                    geolocalizationActive = true;
                    
                    map.setView([lat, lng], accuracy < 100 ? 16 : 14);
                    
                    // Supprimer le marqueur pr√©c√©dent s'il existe
                    if (window.locationMarker) {
                        map.removeLayer(window.locationMarker);
                    }
                    
                    // Marqueur de position avec cercle de pr√©cision
                    const locationIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    window.locationMarker = L.marker([lat, lng], { icon: locationIcon })
                        .addTo(map)
                        .bindPopup(`üìç Votre position<br>Coordonn√©es: ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>Pr√©cision: ¬±${Math.round(accuracy)}m`)
                        .openPopup();
                    
                    if (accuracy < 200) {
                        L.circle([lat, lng], {
                            radius: accuracy,
                            color: '#007bff',
                            fillColor: '#007bff',
                            fillOpacity: 0.2,
                            weight: 2
                        }).addTo(map);
                    }
                    
                    // Remplir le champ de recherche avec les coordonn√©es (comme V2)
                    const searchInput = document.getElementById('search-input');
                    if (searchInput) {
                        searchInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                    
                    console.log(`üìç Position GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${accuracy}m)`);
                },
                (error) => {
                    document.body.removeChild(statusDiv);
                    
                    let errorMsg = '‚ùå Erreur de g√©olocalisation: ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Acc√®s refus√©. Autorisez la g√©olocalisation dans votre navigateur.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Position indisponible. V√©rifiez votre connexion GPS/WiFi.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'D√©lai d√©pass√©. R√©essayez.';
                            break;
                        default:
                            errorMsg += 'Erreur inconnue.';
                            break;
                    }
                    alert(errorMsg);
                    console.error('Erreur g√©olocalisation:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }
        
        // ========== SYST√àME SNCF SOPHISTIQU√â ==========
        
        // Chargement des donn√©es SNCF officielles (int√©gr√©es)
        async function loadSNCFData() {
            console.log('üöÑ Initialisation des donn√©es SNCF int√©gr√©es...');
            
            try {
                // Les donn√©es sont d√©j√† int√©gr√©es dans le code
                console.log(`‚úÖ ${garesData.length} gares SNCF disponibles`);
                
                // Charger les donn√©es GeoJSON ferroviaires d'Occitanie
                await loadGeoJsonData();
                
                console.log('üéØ Syst√®me SNCF op√©rationnel !');
                
                // Afficher un message informatif
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = `
                    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
                    background: #28a745; color: white; padding: 10px 20px; border-radius: 5px;
                    z-index: 10000; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                infoDiv.innerHTML = `üöÑ Donn√©es SNCF charg√©es: ${garesData.length} gares + donn√©es GeoJSON Occitanie`;
                document.body.appendChild(infoDiv);
                
                setTimeout(() => {
                    if (infoDiv.parentNode) infoDiv.parentNode.removeChild(infoDiv);
                }, 3000);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur lors de l\'initialisation SNCF:', error);
                console.log('üìç Utilisation des coordonn√©es par d√©faut');
            }
        }
        
        // Chargement et traitement des donn√©es GeoJSON ferroviaires (int√©gr√©es)
        async function loadGeoJsonData() {
            console.log('üó∫Ô∏è Initialisation des donn√©es ferroviaires d\'Occitanie...');
            
            try {
                // Donn√©es ferroviaires int√©gr√©es bas√©es sur le GeoJSON d'Occitanie
                initializeIntegratedRailwayData();
                console.log(`‚úÖ Donn√©es ferroviaires d'Occitanie int√©gr√©es`);
                console.log('üéØ Couverture g√©ographique √©tendue pr√™te');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur initialisation donn√©es ferroviaires:', error);
                console.log('üìç Utilisation des donn√©es de base');
            }
        }
        
        // Initialisation des donn√©es ferroviaires int√©gr√©es
        function initializeIntegratedRailwayData() {
            // Donn√©es extraites du GeoJSON export_ferroviaire (1).geojson
            const lignesData = [
                {
                    nom: "Ligne de Bordeaux-Saint-Jean √† S√®te-Ville",
                    codes: ["640000", "650000"],
                    coordinates: [
                        { pk: 0, lat: 44.8262, lng: -0.5563 },      // Bordeaux Saint-Jean
                        { pk: 30, lat: 44.7506, lng: -0.4853 },     // Cenon
                        { pk: 60, lat: 44.6789, lng: -0.3845 },     // Libourne
                        { pk: 100, lat: 44.5545, lng: -0.2486 },    // Langon
                        { pk: 130, lat: 44.4821, lng: -0.1234 },    // La R√©ole
                        { pk: 160, lat: 44.3567, lng: 0.2187 },     // Marmande
                        { pk: 200, lat: 44.2036, lng: 0.6203 },     // Agen
                        { pk: 230, lat: 44.1234, lng: 0.9876 },     // Valence-d'Agen
                        { pk: 250, lat: 44.0174, lng: 1.3546 },     // Montauban
                        { pk: 270, lat: 43.8745, lng: 1.4021 },     // Bressols
                        { pk: 300, lat: 43.6109, lng: 1.4543 },     // Toulouse Matabiau
                        { pk: 330, lat: 43.4892, lng: 1.6734 },     // Bazi√®ge
                        { pk: 350, lat: 43.3190, lng: 1.9530 },     // Castelnaudary
                        { pk: 380, lat: 43.2756, lng: 2.1845 },     // Bram
                        { pk: 400, lat: 43.2164, lng: 2.3498 },     // Carcassonne
                        { pk: 430, lat: 43.1987, lng: 2.7234 },     // L√©zignan-Corbi√®res
                        { pk: 450, lat: 43.1839, lng: 3.0038 },     // Narbonne
                        { pk: 470, lat: 43.2891, lng: 3.1456 },     // Coursan
                        { pk: 500, lat: 43.3467, lng: 3.2152 },     // B√©ziers
                        { pk: 530, lat: 43.4521, lng: 3.5234 },     // Agde
                        { pk: 550, lat: 43.6052, lng: 3.8781 }      // Montpellier/S√®te
                    ]
                },
                {
                    nom: "Ligne de Toulouse √† Bayonne",
                    codes: ["590000"],
                    coordinates: [
                        { pk: 0, lat: 43.6109, lng: 1.4543 },       // Toulouse Matabiau
                        { pk: 25, lat: 43.5678, lng: 1.2845 },      // Muret
                        { pk: 50, lat: 43.4756, lng: 1.0234 },      // Boussens
                        { pk: 75, lat: 43.4321, lng: 0.7891 },      // Saint-Gaudens
                        { pk: 100, lat: 43.4929, lng: 0.5806 },     // Auch r√©gion
                        { pk: 130, lat: 43.4678, lng: 0.2345 },     // Mirande
                        { pk: 160, lat: 43.4512, lng: -0.1234 },    // Aire-sur-l'Adour
                        { pk: 200, lat: 43.4832, lng: -0.3707 },    // Pau
                        { pk: 230, lat: 43.4789, lng: -0.6891 },    // Orthez
                        { pk: 260, lat: 43.4756, lng: -1.0234 },    // Puyo√¥
                        { pk: 300, lat: 43.4843, lng: -1.4960 }     // Bayonne
                    ]
                },
                {
                    nom: "Ligne de Toulouse √† Auch",
                    codes: ["667000"],
                    coordinates: [
                        { pk: 0, lat: 43.6109, lng: 1.4543 },       // Toulouse
                        { pk: 20, lat: 43.5234, lng: 1.2845 },      // L'Isle-Jourdain
                        { pk: 40, lat: 43.4789, lng: 1.0567 },      // Gimont
                        { pk: 60, lat: 43.4321, lng: 0.8234 },      // Auch r√©gion
                        { pk: 80, lat: 43.6462, lng: 0.5860 }       // Auch
                    ]
                },
                {
                    nom: "Ligne de Toulouse √† Albi",
                    codes: ["668000"],
                    coordinates: [
                        { pk: 0, lat: 43.6109, lng: 1.4543 },       // Toulouse
                        { pk: 20, lat: 43.7234, lng: 1.6789 },      // Bessi√®res
                        { pk: 40, lat: 43.8456, lng: 1.8234 },      // Montastruc
                        { pk: 60, lat: 43.9234, lng: 2.1456 },      // Albi Sud
                        { pk: 80, lat: 43.9289, lng: 2.1478 }       // Albi-Ville
                    ]
                },
                {
                    nom: "Ligne de Toulouse √† Foix",
                    codes: ["669000"],
                    coordinates: [
                        { pk: 0, lat: 43.6109, lng: 1.4543 },       // Toulouse
                        { pk: 15, lat: 43.5234, lng: 1.4123 },      // Portet-sur-Garonne
                        { pk: 30, lat: 43.4567, lng: 1.3789 },      // Auterive
                        { pk: 50, lat: 43.3789, lng: 1.3456 },      // Carbonne
                        { pk: 70, lat: 43.1789, lng: 1.6123 },      // Foix
                        { pk: 90, lat: 42.9678, lng: 1.8456 }       // Ax-les-Thermes
                    ]
                },
                {
                    nom: "Ligne de Brive √† Toulouse",
                    codes: ["718000"],
                    coordinates: [
                        { pk: 0, lat: 45.1580, lng: 1.5339 },       // Brive-la-Gaillarde
                        { pk: 50, lat: 44.8934, lng: 1.9045 },      // Figeac
                        { pk: 100, lat: 44.4567, lng: 2.2234 },     // Villefranche-de-Rouergue
                        { pk: 150, lat: 44.0123, lng: 2.0789 },     // Najac r√©gion
                        { pk: 200, lat: 43.7234, lng: 1.8456 },     // Lexos
                        { pk: 250, lat: 43.6109, lng: 1.4543 }      // Toulouse
                    ]
                },
                {
                    nom: "Ligne de Perpignan √† Toulouse",
                    codes: ["672000"],
                    coordinates: [
                        { pk: 0, lat: 42.6886, lng: 2.8948 },       // Perpignan
                        { pk: 50, lat: 43.0234, lng: 2.6789 },      // Quillan r√©gion
                        { pk: 100, lat: 43.2164, lng: 2.3498 },     // Carcassonne
                        { pk: 150, lat: 43.3190, lng: 1.9530 },     // Castelnaudary
                        { pk: 200, lat: 43.6109, lng: 1.4543 }      // Toulouse
                    ]
                },
                {
                    nom: "Ligne de Tarbes √† Toulouse",
                    codes: ["671000"],
                    coordinates: [
                        { pk: 0, lat: 43.2328, lng: 0.0833 },       // Tarbes
                        { pk: 30, lat: 43.3456, lng: 0.4567 },      // Lannemezan
                        { pk: 60, lat: 43.4234, lng: 0.7890 },      // Saint-Gaudens
                        { pk: 90, lat: 43.5123, lng: 1.1234 },      // Caz√®res
                        { pk: 120, lat: 43.6109, lng: 1.4543 }      // Toulouse
                    ]
                },
                {
                    nom: "Ligne de Castres √† Toulouse",
                    codes: ["675000"],
                    coordinates: [
                        { pk: 0, lat: 43.6052, lng: 2.2378 },       // Castres
                        { pk: 20, lat: 43.6234, lng: 2.0567 },      // Labrugui√®re
                        { pk: 40, lat: 43.6345, lng: 1.8789 },      // Revel
                        { pk: 60, lat: 43.6234, lng: 1.6234 },      // Villefranche-de-Lauragais
                        { pk: 80, lat: 43.6109, lng: 1.4543 }       // Toulouse
                    ]
                },
                {
                    nom: "Ligne de Mazamet √† B√©ziers",
                    codes: ["677000"],
                    coordinates: [
                        { pk: 0, lat: 43.4892, lng: 2.3728 },       // Mazamet
                        { pk: 30, lat: 43.4234, lng: 2.6789 },      // Saint-Pons
                        { pk: 60, lat: 43.3789, lng: 3.0234 },      // B√©darieux
                        { pk: 90, lat: 43.3467, lng: 3.2152 }       // B√©ziers
                    ]
                },
                {
                    nom: "Ligne de Saint-Germain-des-Foss√©s √† N√Æmes-Courbessac",
                    codes: ["738000"],
                    coordinates: [
                        { pk: 0, lat: 46.2044, lng: 3.4406 },       // Saint-Germain-des-Foss√©s
                        { pk: 50, lat: 45.6234, lng: 3.6789 },      // Langeac
                        { pk: 100, lat: 45.0445, lng: 3.8837 },     // Le Puy-en-Velay
                        { pk: 150, lat: 44.5123, lng: 3.9456 },     // Mende r√©gion
                        { pk: 200, lat: 44.3633, lng: 4.0421 },     // Al√®s
                        { pk: 225, lat: 44.1234, lng: 4.1789 },     // Anduze
                        { pk: 250, lat: 43.8368, lng: 4.3601 }      // N√Æmes
                    ]
                },
                {
                    nom: "Ligne de Tarascon √† S√®te",
                    codes: ["675000"],
                    coordinates: [
                        { pk: 0, lat: 43.8057, lng: 4.6603 },       // Tarascon
                        { pk: 25, lat: 43.7234, lng: 4.4567 },      // Lunel
                        { pk: 50, lat: 43.6764, lng: 4.1258 },      // Montpellier
                        { pk: 75, lat: 43.5234, lng: 3.9456 },      // Frontignan
                        { pk: 100, lat: 43.4039, lng: 3.6967 }      // S√®te
                    ]
                },
                {
                    nom: "Ligne de Perpignan √† Villefranche-Vernet-les-Bains",
                    codes: ["648000"],
                    coordinates: [
                        { pk: 0, lat: 42.6886, lng: 2.8948 },       // Perpignan
                        { pk: 25, lat: 42.6234, lng: 2.7456 },      // Ille-sur-T√™t
                        { pk: 50, lat: 42.5462, lng: 2.3750 }       // Villefranche-Vernet-les-Bains
                    ]
                }
            ];
            
            // Indexer les donn√©es
            lignesData.forEach(ligne => {
                ligne.codes.forEach(code => {
                    lignesGeoJson.set(code, {
                        nom: ligne.nom,
                        segments: ligne.coordinates,
                        boundingBox: calculateBoundingBox(ligne.coordinates)
                    });
                    
                    // Indexer aussi par nom
                    lignesGeoJson.set(ligne.nom.toLowerCase(), {
                        nom: ligne.nom,
                        segments: ligne.coordinates,
                        boundingBox: calculateBoundingBox(ligne.coordinates)
                    });
                });
            });
            
            console.log(`ÔøΩ ${lignesGeoJson.size} lignes ferroviaires d'Occitanie index√©es`);
        }
        
        // Calcul de la bounding box pour une s√©rie de coordonn√©es
        function calculateBoundingBox(coordinates) {
            let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
            
            coordinates.forEach(coord => {
                minLat = Math.min(minLat, coord.lat);
                maxLat = Math.max(maxLat, coord.lat);
                minLng = Math.min(minLng, coord.lng);
                maxLng = Math.max(maxLng, coord.lng);
            });
            
            return { minLat, maxLat, minLng, maxLng };
        }
        
        
        // Recherche de coordonn√©es dans les donn√©es GeoJSON int√©gr√©es
        function findCoordinatesInGeoJson(ligne, pkDebut) {
            if (lignesGeoJson.size === 0) {
                return null;
            }
            
            // Essayer de trouver la ligne par code direct
            const ligneStr = ligne.toString();
            let ligneInfo = lignesGeoJson.get(ligneStr);
            
            // Si pas trouv√©, essayer par correspondance de noms
            if (!ligneInfo) {
                const correspondances = {
                    '640000': 'bordeaux',
                    '650000': 's√®te',
                    '738000': 'n√Æmes',
                    '672000': 'tarascon',
                    '590000': 'bayonne',
                    '648000': 'perpignan',
                    '667000': 'toulouse',
                    '668000': 'toulouse',
                    '718000': 'saint-germain'
                };
                
                const motClef = correspondances[ligneStr];
                if (motClef) {
                    for (let [key, info] of lignesGeoJson) {
                        if (key.includes(motClef)) {
                            ligneInfo = info;
                            break;
                        }
                    }
                }
            }
            
            if (!ligneInfo || !ligneInfo.segments || ligneInfo.segments.length === 0) {
                return null;
            }
            
            // Calculer la position par interpolation sur les segments
            const pkNum = parseFloat(pkDebut.toString().replace('+', '.').replace(',', '.'));
            if (isNaN(pkNum)) return null;
            
            // Trouver les deux points les plus proches pour interpoler
            const segments = ligneInfo.segments;
            let pointAvant = segments[0];
            let pointApres = segments[segments.length - 1];
            
            for (let i = 0; i < segments.length - 1; i++) {
                if (segments[i].pk <= pkNum && segments[i + 1].pk >= pkNum) {
                    pointAvant = segments[i];
                    pointApres = segments[i + 1];
                    break;
                }
            }
            
            // Interpolation lin√©aire
            let lat, lng;
            if (pointAvant.pk === pointApres.pk) {
                lat = pointAvant.lat;
                lng = pointAvant.lng;
            } else {
                const ratio = (pkNum - pointAvant.pk) / (pointApres.pk - pointAvant.pk);
                lat = pointAvant.lat + (pointApres.lat - pointAvant.lat) * ratio;
                lng = pointAvant.lng + (pointApres.lng - pointAvant.lng) * ratio;
            }
            
            return {
                lat: lat,
                lng: lng,
                source: `GeoJSON-${ligneInfo.nom}-PK${pkDebut}`,
                ligne: ligne,
                pk: pkDebut,
                qualite: 'geojson-integre'
            };
        }
        
        // Recherche dans les donn√©es locales SNCF
        function findCoordinatesInLocalData(ligne, pk) {
            if (!sncfDataLoaded) return null;
            
            const ligneFormatted = ligne.toString().padStart(6, '0');
            const pkValue = parseFloat(pk.toString().replace('+', '.'));
            
            if (isNaN(pkValue)) return null;
            
            // Chercher dans les gares (tol√©rance ¬±5km)
            const gareMatch = garesData.find(gare => {
                if (!gare.code_ligne || !gare.pk) return false;
                const gareCodeLigne = gare.code_ligne.toString().padStart(6, '0');
                const garePk = parseFloat(gare.pk.toString().replace('+', '.'));
                
                return gareCodeLigne === ligneFormatted && Math.abs(garePk - pkValue) < 5;
            });
            
            if (gareMatch && gareMatch.x_wgs84 && gareMatch.y_wgs84) {
                console.log(`üöâ Gare trouv√©e: ${gareMatch.libelle} (PK ${pk})`);
                return {
                    lat: gareMatch.y_wgs84,
                    lng: gareMatch.x_wgs84,
                    source: `Gare-${gareMatch.libelle || 'Inconnue'}-PK${pk}`,
                    detail: gareMatch
                };
            }
            
            // Chercher dans les passages √† niveau (tol√©rance ¬±2km)
            const pnMatch = passagesNiveauData.find(pn => {
                if (!pn.code_ligne || !pn.pk) return false;
                const pnCodeLigne = pn.code_ligne.toString().padStart(6, '0');
                const pnPk = parseFloat(pn.pk.toString().replace('+', '.'));
                
                return pnCodeLigne === ligneFormatted && Math.abs(pnPk - pkValue) < 2;
            });
            
            if (pnMatch && pnMatch.x_wgs84 && pnMatch.y_wgs84) {
                console.log(`üöß PN trouv√©: ${pnMatch.libelle} (PK ${pk})`);
                return {
                    lat: pnMatch.y_wgs84,
                    lng: pnMatch.x_wgs84,
                    source: `PN-${pnMatch.libelle || 'Inconnu'}-PK${pk}`,
                    detail: pnMatch
                };
            }
            
            // Chercher dans les quais (tol√©rance ¬±1km)
            const quaiMatch = quaisData.find(quai => {
                if (!quai.code_ligne || !quai.pk) return false;
                const quaiCodeLigne = quai.code_ligne.toString().padStart(6, '0');
                const quaiPk = parseFloat(quai.pk.toString().replace('+', '.'));
                
                return quaiCodeLigne === ligneFormatted && Math.abs(quaiPk - pkValue) < 1;
            });
            
            if (quaiMatch && quaiMatch.x_wgs84 && quaiMatch.y_wgs84) {
                console.log(`üöÇ Quai trouv√©: ${quaiMatch.libelle} (PK ${pk})`);
                return {
                    lat: quaiMatch.y_wgs84,
                    lng: quaiMatch.x_wgs84,
                    source: `Quai-${quaiMatch.libelle || 'Inconnu'}-PK${pk}`,
                    detail: quaiMatch
                };
            }
            
            // Interpolation bas√©e sur plusieurs points de la ligne
            return interpolateCoordinatesOnLine(ligne, pkValue);
        }
        
        // Fonction d'interpolation avanc√©e
        function interpolateCoordinatesOnLine(ligne, pkValue) {
            if (!sncfDataLoaded) return null;
            
            const ligneFormatted = ligne.toString().padStart(6, '0');
            
            // Rassembler tous les points de la ligne
            const lignePoints = [
                ...garesData.filter(g => g.code_ligne && g.code_ligne.toString().padStart(6, '0') === ligneFormatted),
                ...passagesNiveauData.filter(p => p.code_ligne && p.code_ligne.toString().padStart(6, '0') === ligneFormatted)
            ].filter(point => point.pk && point.x_wgs84 && point.y_wgs84)
             .map(point => ({
               pk: parseFloat(point.pk.toString().replace('+', '.')),
               lat: point.y_wgs84,
               lng: point.x_wgs84,
               libelle: point.libelle || 'Point'
             }))
             .sort((a, b) => a.pk - b.pk);
            
            if (lignePoints.length < 2) return null;
            
            // Trouver les deux points encadrants
            let beforePoint = null;
            let afterPoint = null;
            
            for (let i = 0; i < lignePoints.length - 1; i++) {
                if (pkValue >= lignePoints[i].pk && pkValue <= lignePoints[i + 1].pk) {
                    beforePoint = lignePoints[i];
                    afterPoint = lignePoints[i + 1];
                    break;
                }
            }
            
            if (!beforePoint || !afterPoint) {
                // Prendre le point le plus proche
                const closest = lignePoints.reduce((prev, curr) =>
                    Math.abs(curr.pk - pkValue) < Math.abs(prev.pk - pkValue) ? curr : prev
                );
                
                console.log(`üéØ Interpolation: Point le plus proche utilis√© (${closest.libelle})`);
                return {
                    lat: closest.lat,
                    lng: closest.lng,
                    source: `Interpolation-${ligne}-PK${pkValue}-Proche-${closest.libelle}`
                };
            }
            
            // Interpolation lin√©aire entre les deux points
            const ratio = (pkValue - beforePoint.pk) / (afterPoint.pk - beforePoint.pk);
            const lat = beforePoint.lat + (afterPoint.lat - beforePoint.lat) * ratio;
            const lng = beforePoint.lng + (afterPoint.lng - beforePoint.lng) * ratio;
            
            console.log(`üéØ Interpolation: Entre ${beforePoint.libelle} et ${afterPoint.libelle} (ratio: ${ratio.toFixed(2)})`);
            return {
                lat: lat,
                lng: lng,
                source: `Interpolation-${ligne}-PK${pkValue}-Entre-${beforePoint.libelle}-${afterPoint.libelle}`
            };
        }
        
        // Fonction pour afficher les d√©tails d'un projet avec les vraies donn√©es
        function showProjectDetailsNew(correspondence, bpteProject) {
            try {
                const modalId = 'projectDetailsModal';
                
                // Supprimer modal existant
                const existingModal = document.getElementById(modalId);
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Cr√©er le modal
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                    justify-content: center; align-items: center; padding: 20px;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; border-radius: 15px; max-width: 95%; max-height: 95%;
                    overflow-y: auto; padding: 25px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                `;
                
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '√ó';
                closeBtn.style.cssText = `
                    position: absolute; top: 15px; right: 20px; background: #dc3545;
                    color: white; border: none; border-radius: 50%; width: 35px; height: 35px;
                    cursor: pointer; font-size: 20px; z-index: 1;
                `;
                closeBtn.onclick = () => modal.remove();
                
                // Utiliser directement la correspondance pass√©e en param√®tre
                const adminData = correspondence ? correspondence.adminData : null;
                const bpteData = correspondence ? correspondence.bpteData : null;
                
                console.log('üîç Affichage projet:', correspondence);
                console.log('üìä Admin data:', adminData);
                console.log('üìä BPTE data:', bpteData);
                
                content.innerHTML = `
                    <h2 style="color: #fd7e14; margin: 0 0 20px 0; padding-right: 50px;">
                        üìã D√©tails du Projet ${correspondence ? correspondence.code_f : 'N/A'}
                    </h2>
                    
                    <!-- INFORMATIONS G√âN√âRALES -->
                    <div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #fd7e14;">
                        <h3 style="color: #fd7e14; margin: 0 0 15px 0;">üìå Informations G√©n√©rales</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>Code F :</strong> ${correspondence ? correspondence.code_f : 'N/A'}</p>
                                <p><strong>Nom Admin :</strong> ${adminData && adminData.allColumns ? (adminData.allColumns.Nom || adminData.nom || 'N/A') : 'N/A'}</p>
                                <p><strong>Nom BPTE :</strong> ${bpteData ? (bpteData.nom || 'N/A') : 'N/A'}</p>
                                <p><strong>COP C6-H-BPTE :</strong> ${adminData && adminData.allColumns ? (adminData.allColumns['COP_C6-H-BPTE'] || adminData.allColumns['COP C6-H-BPTE'] || 'N/A') : 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Nature :</strong> ${adminData && adminData.allColumns ? (adminData.allColumns.Nature || 'N/A') : 'N/A'}</p>
                                <p><strong>Statut planning :</strong> ${adminData && adminData.allColumns ? (adminData.allColumns['Statut planning'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Portefeuille :</strong> ${adminData && adminData.allColumns ? (adminData.allColumns.Portefeuille || 'N/A') : 'N/A'}</p>
                                <p><strong>CEP :</strong> ${adminData && adminData.allColumns ? (adminData.allColumns.CEP || 'N/A') : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${bpteData ? `
                    <!-- DONN√âES BPTE D√âTAILL√âES -->
                    <div style="margin-bottom: 25px; padding: 15px; background: #fff0e6; border-radius: 8px; border-left: 4px solid #fd7e14;">
                        <h3 style="color: #fd7e14; margin: 0 0 15px 0;">üìä Donn√©es BPTE Compl√®tes</h3>
                        <div style="max-height: 600px; overflow-y: auto;">
                            
                            <!-- IDENTIFIANTS & CODES -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <h4 style="color: #fd7e14; margin: 0 0 10px 0;">üî¢ Identifiants & Codes</h4>
                                    <p><strong>Cl√© Banque Travaux :</strong> ${bpteData.rawData ? (bpteData.rawData['Cl√© Banque Travaux'] || bpteData.rawData['#CleBanqueTravaux: Code'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Num compte GEREMI :</strong> ${bpteData.rawData ? (bpteData.rawData['Num compte GEREMI'] || bpteData.geremi || 'N/A') : (bpteData.geremi || 'N/A')}</p>
                                    <p><strong>JV de l'Op√©ration :</strong> ${bpteData.rawData ? (bpteData.rawData['JV de l\'Op√©ration'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>R√©f√©rence EMERGENCE :</strong> ${bpteData.rawData ? (bpteData.rawData['R√©f√©rence EMERGENCE'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>JV de l'Emergence :</strong> ${bpteData.rawData ? (bpteData.rawData['JV de l\'Emergence'] || 'N/A') : 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 style="color: #fd7e14; margin: 0 0 10px 0;">üöÇ Infrastructure</h4>
                                    <p><strong>Lignes :</strong> ${bpteData.rawData ? (bpteData.rawData['Lignes'] || bpteData.lignes || 'N/A') : (bpteData.lignes || 'N/A')}</p>
                                    <p><strong>Voies :</strong> ${bpteData.rawData ? (bpteData.rawData['Voies'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>PK D√©but :</strong> ${bpteData.rawData ? (bpteData.rawData['PK D√©but projet'] || bpteData.pkDebut || 'N/A') : (bpteData.pkDebut || 'N/A')}</p>
                                    <p><strong>PK Fin :</strong> ${bpteData.rawData ? (bpteData.rawData['PK Fin projet'] || bpteData.pkFin || 'N/A') : (bpteData.pkFin || 'N/A')}</p>
                                    <p><strong>Axe de Production :</strong> ${bpteData.rawData ? (bpteData.rawData['Axe de Production'] || 'N/A') : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- ORGANISATION & PLANNING -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <h4 style="color: #fd7e14; margin: 0 0 10px 0;">üè¢ Organisation</h4>
                                    <p><strong>Direction M&T :</strong> ${bpteData.rawData ? (bpteData.rawData['Direction M&T'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>AMT :</strong> ${bpteData.rawData ? (bpteData.rawData['AMT'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>DT R√©seau :</strong> ${bpteData.rawData ? (bpteData.rawData['DT R√©seau'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>R√©gion SNCF :</strong> ${bpteData.rawData ? (bpteData.rawData['Libell√© r√©gion SNCF'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>MOA :</strong> ${bpteData.rawData ? (bpteData.rawData['MOA'] || 'N/A') : 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 style="color: #fd7e14; margin: 0 0 10px 0;">üìÖ Planning GEREMI</h4>
                                    <p><strong>Phase en cours :</strong> ${bpteData.rawData ? (bpteData.rawData['Phase en cours GEREMI'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Statut GEREMI :</strong> ${bpteData.rawData ? (bpteData.rawData['Statut GEREMI'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Date MES Op√©ration :</strong> ${formatDate(bpteData.rawData ? bpteData.rawData['Date de MES de l\'Op√©ration'] : null)}</p>
                                    <p><strong>Date fin AVP :</strong> ${formatDate(bpteData.rawData ? bpteData.rawData['Date fin AVP'] : null)}</p>
                                    <p><strong>Date fin REA :</strong> ${formatDate(bpteData.rawData ? bpteData.rawData['Date fin REA'] : null)}</p>
                                </div>
                            </div>
                            
                            <!-- FINANCES -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #fd7e14; margin: 0 0 10px 0;">üí∞ Donn√©es Financi√®res</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                    <div>
                                        <p><strong>CP r√©f√©rence :</strong> ${formatCurrency(bpteData.rawData ? bpteData.rawData['CP r√©f√©rence'] : null)}</p>
                                        <p><strong>Pr√©vision CP RNI :</strong> ${formatCurrency(bpteData.rawData ? bpteData.rawData['Pr√©vision CP RNI'] : null)}</p>
                                    </div>
                                    <div>
                                        <p><strong>Pr√©vision CP GEREMI :</strong> ${formatCurrency(bpteData.rawData ? bpteData.rawData['Pr√©vision CP GEREMI'] : null)}</p>
                                        <p><strong>CP AMT :</strong> ${formatCurrency(bpteData.rawData ? bpteData.rawData['CP AMT'] : null)}</p>
                                    </div>
                                    <div>
                                        <p><strong>Eligible RP0 :</strong> ${bpteData.rawData ? (bpteData.rawData['Eligible RP0'] || 'N/A') : 'N/A'}</p>
                                        <p><strong>Priorit√© CPA :</strong> ${bpteData.rawData ? (bpteData.rawData['Priorit√© CPA'] || 'N/A') : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PROJETS & PROGRAMMES -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #fd7e14; margin: 0 0 10px 0;">üìã Projets & Programmes</h4>
                                <p><strong>Libell√© projet pluriannuel :</strong> ${bpteData.rawData ? (bpteData.rawData['Libell√© projet pluriannuel'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Libell√© projet annuel :</strong> ${bpteData.rawData ? (bpteData.rawData['Libell√© projet annuel'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Libell√© op√©ration GEREMI :</strong> ${bpteData.rawData ? (bpteData.rawData['Libell√© op√©ration GEREMI'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Programme :</strong> ${bpteData.rawData ? (bpteData.rawData['Programme'] || 'N/A') : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    ` : '<div style="padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;"><strong>‚ö†Ô∏è Aucune donn√©e BPTE correspondante trouv√©e</strong></div>'}
                    
                    <!-- DONN√âES ADMIN D√âTAILL√âES -->
                    ${adminData && adminData.allColumns ? `
                    <div style="margin-bottom: 25px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #007bff;">
                        <h3 style="color: #007bff; margin: 0 0 15px 0;">üóÇÔ∏è Donn√©es Admin Compl√®tes</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>Code planning :</strong> ${adminData.allColumns['Code planning'] || 'N/A'}</p>
                                <p><strong>Orga DT :</strong> ${adminData.allColumns['Orga DT'] || 'N/A'}</p>
                                <p><strong>Type :</strong> ${adminData.allColumns['Type.'] || adminData.allColumns['Type'] || 'N/A'}</p>
                                <p><strong>Famille de type :</strong> ${adminData.allColumns['Famille de type'] || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Commande ing√©nierie :</strong> ${adminData.allColumns['Commande ing√©nierie.'] || adminData.allColumns['Commande ing√©nierie'] || 'N/A'}</p>
                                <p><strong>Version :</strong> ${adminData.allColumns['Version'] || 'N/A'}</p>
                                <p><strong>Publi√© le :</strong> ${formatDate(adminData.allColumns['Publi√© le'])}</p>
                                <p><strong>Cr√©ateur :</strong> ${adminData.allColumns['Cr√©ateur'] || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Porteur planning :</strong> ${adminData.allColumns['Porteur planning'] || 'N/A'}</p>
                                <p><strong>√âtat suivant autoris√© :</strong> ${adminData.allColumns['√âtat suivant autoris√©'] || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- BOUTONS D'ACTION -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="window.open('https://www.openrailwaymap.org/?style=standard&lat=${correspondence && correspondence.coordinates ? correspondence.coordinates.lat : 43.6045}&lon=${correspondence && correspondence.coordinates ? correspondence.coordinates.lng : 1.4442}&zoom=15', '_blank')" 
                                style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                            üó∫Ô∏è Voir sur OpenRailwayMap
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                            Fermer
                        </button>
                    </div>
                `;
                
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Fermeture en cliquant sur le fond
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('Erreur affichage d√©tails projet:', error);
                alert('Erreur lors de l\'affichage des d√©tails du projet');
            }
        }

        // Fonction pour afficher les d√©tails d'un projet
        function showProjectDetails(project, bpteProject) {
            try {
                const modalId = 'projectDetailsModal';
                
                // Supprimer modal existant
                const existingModal = document.getElementById(modalId);
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Cr√©er nouveau modal
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0,0,0,0.7); z-index: 10000;
                    display: flex; justify-content: center; align-items: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; padding: 20px; border-radius: 8px;
                    max-width: 900px; max-height: 80%; overflow-y: auto;
                    position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                
                // Bouton fermeture
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '‚úï';
                closeBtn.style.cssText = `
                    position: absolute; top: 10px; right: 15px;
                    background: #dc3545; color: white; border: none;
                    border-radius: 50%; width: 30px; height: 30px;
                    cursor: pointer; font-size: 16px; font-weight: bold;
                `;
                closeBtn.addEventListener('click', () => modal.remove());
                
                const projectCode = project.F1 || bpteProject?.F1 || 'N/A';
                const title = project.F7 || project.F2 || 'Projet sans titre';
                
                content.innerHTML = `
                    <h2 style="color: #28a745; margin-bottom: 20px; padding-right: 40px;">
                        üöÇ Fiche Projet Ferroviaire : ${projectCode}
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="color: #17a2b8; border-bottom: 2px solid #17a2b8; padding-bottom: 5px;">
                                üìã Informations G√©n√©rales
                            </h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <p><strong>Code Projet :</strong> ${projectCode}</p>
                                <p><strong>Titre :</strong> ${title}</p>
                                <p><strong>Ligne(s) :</strong> ${project.F4 || 'N/A'}</p>
                                <p><strong>PK D√©but :</strong> ${project.F5 || 'N/A'}</p>
                                <p><strong>PK Fin :</strong> ${project.F6 || 'N/A'}</p>
                                <p><strong>Longueur :</strong> ${project.F8 || 'N/A'}</p>
                                <p><strong>Statut :</strong> ${project.F9 || 'N/A'}</p>
                                ${project.description ? `<p><strong>Description :</strong> ${project.description}</p>` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 5px;">
                                üí∞ Donn√©es Financi√®res
                            </h3>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 5px;">
                                <p><strong>Budget Total :</strong> ${formatCurrency(project.F12)}</p>
                                <p><strong>CEP :</strong> ${project.F10 || 'N/A'}</p>
                                <p><strong>CDP :</strong> ${project.F13 || 'N/A'}</p>
                                <p><strong>BPTE :</strong> ${project.F14 || 'N/A'}</p>
                                <p><strong>√âcart Budget :</strong> ${calculateBudgetDifference(project)}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${project.dateDebut || project.dateFin || project.responsable || project.typeOperation ? `
                    <div style="margin-top: 20px;">
                        <h3 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 5px;">
                            üìÖ Donn√©es BPTE Enrichies
                        </h3>
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    ${project.dateDebut ? `<p><strong>Date d√©but :</strong> ${project.dateDebut}</p>` : ''}
                                    ${project.dateFin ? `<p><strong>Date fin :</strong> ${project.dateFin}</p>` : ''}
                                    ${project.responsable ? `<p><strong>Responsable :</strong> ${project.responsable}</p>` : ''}
                                    ${project.region ? `<p><strong>R√©gion :</strong> ${project.region}</p>` : ''}
                                </div>
                                <div>
                                    ${project.typeOperation ? `<p><strong>Type op√©ration :</strong> ${project.typeOperation}</p>` : ''}
                                    ${project.priorite ? `<p><strong>Priorit√© :</strong> ${project.priorite}</p>` : ''}
                                    ${project.infrastructure ? `<p><strong>Infrastructure :</strong> ${project.infrastructure}</p>` : ''}
                                    ${project.coordinates ? `<p><strong>Source coordonn√©es :</strong> ${project.coordinates.source}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px;">
                        <h3 style="color: #6f42c1; border-bottom: 2px solid #6f42c1; padding-bottom: 5px;">
                            üöÜ D√©tails Techniques Ferroviaires
                        </h3>
                        <div style="background: #e7e3ff; padding: 15px; border-radius: 5px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <p><strong>Type d'infrastructure :</strong> ${getInfrastructureType(project)}</p>
                                    <p><strong>Zone g√©ographique :</strong> ${getGeographicZone(project.F4)}</p>
                                    <p><strong>Priorit√© :</strong> ${getPriority(project)}</p>
                                </div>
                                <div>
                                    <p><strong>√âtat d'avancement :</strong> ${getProgressStatus(project.F9)}</p>
                                    <p><strong>Complexit√© estim√©e :</strong> ${getComplexity(project)}</p>
                                    <p><strong>Impact trafic :</strong> ${getTrafficImpact(project)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${bpteProject ? `
                    <div style="margin-top: 20px;">
                        <h3 style="color: #fd7e14; border-bottom: 2px solid #fd7e14; padding-bottom: 5px;">
                            üìä Donn√©es BPTE D√©taill√©es
                        </h3>
                        <div style="background: #fff0e6; padding: 15px; border-radius: 5px; max-height: 650px; overflow-y: auto;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #fd7e14; margin: 10px 0;">ÔøΩ Identifiants & Codes BPTE</h4>
                                    <p><strong>Cl√© Banque Travaux :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Cl√© Banque Travaux'] || bpteProject.rawData['#CleBanqueTravaux: Code'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Num compte GEREMI :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Num compte GEREMI'] || bpteProject.geremi || 'N/A') : (bpteProject.geremi || 'N/A')}</p>
                                    <p><strong>JV de l'Op√©ration :</strong> ${bpteProject.rawData ? (bpteProject.rawData['JV de l\'Op√©ration'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>R√©f√©rence EMERGENCE :</strong> ${bpteProject.rawData ? (bpteProject.rawData['R√©f√©rence EMERGENCE'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>JV de l'Emergence :</strong> ${bpteProject.rawData ? (bpteProject.rawData['JV de l\'Emergence'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Code Typo annuel :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Code Typo annuel'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Code Typo pluriannuel :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Code Typo pluriannuel'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Libell√© Code typo annuel :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Libell√© Code typo annuel'] || 'N/A') : 'N/A'}</p>
                                    
                                    <h4 style="color: #fd7e14; margin: 15px 0 10px 0;">üöÇ Infrastructure & G√©ographie</h4>
                                    <p><strong>Lignes :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Lignes'] || bpteProject.lignes || 'N/A') : (bpteProject.lignes || 'N/A')}</p>
                                    <p><strong>Voies :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Voies'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>PK D√©but projet :</strong> ${bpteProject.rawData ? (bpteProject.rawData['PK D√©but projet'] || bpteProject.pkDebut || 'N/A') : (bpteProject.pkDebut || 'N/A')}</p>
                                    <p><strong>PK Fin projet :</strong> ${bpteProject.rawData ? (bpteProject.rawData['PK Fin projet'] || bpteProject.pkFin || 'N/A') : (bpteProject.pkFin || 'N/A')}</p>
                                    <p><strong>Longueur estim√©e :</strong> ${calculateLength(bpteProject.rawData ? (bpteProject.rawData['PK D√©but projet'] || bpteProject.pkDebut) : bpteProject.pkDebut, bpteProject.rawData ? (bpteProject.rawData['PK Fin projet'] || bpteProject.pkFin) : bpteProject.pkFin)}</p>
                                    <p><strong>Axe de Production :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Axe de Production'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Axe r√©f√©rent :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Axe r√©f√©rent'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Axe GPMR :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Axe GPMR'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Axe GPMR G√©ographique :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Axe GPMR G√©ographique'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Groupe UIC :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Groupe UIC'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>R√©seau :</strong> ${bpteProject.rawData ? (bpteProject.rawData['R√©seau structurant/r√©gional/axe'] || 'N/A') : 'N/A'}</p>
                                    <p><strong>Programme :</strong> ${bpteProject['Programme'] || 'N/A'}</p>
                                    <p><strong>Sous programme :</strong> ${bpteProject['sous programme'] || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <h4 style="color: #fd7e14; margin: 10px 0;">üí∞ Donn√©es Financi√®res BPTE</h4>
                                    <p><strong>CP r√©f√©rence :</strong> ${formatCurrency(bpteProject['CP r√©f√©rence'])}</p>
                                    <p><strong>Pr√©vision CP RNI :</strong> ${formatCurrency(bpteProject['Pr√©vision CP RNI'])}</p>
                                    <p><strong>Pr√©vision CP GEREMI :</strong> ${formatCurrency(bpteProject['Pr√©vision CP GEREMI'])}</p>
                                    <p><strong>CP AMT :</strong> ${formatCurrency(bpteProject['CP AMT'])}</p>
                                    <p><strong>Eligible RP0 :</strong> ${bpteProject['Eligible RP0'] || 'N/A'}</p>
                                    
                                    <h4 style="color: #fd7e14; margin: 15px 0 10px 0;">üìÖ Planning & Phases GEREMI</h4>
                                    <p><strong>Date MES Op√©ration :</strong> ${formatDate(bpteProject['Date de MES de l\'Op√©ration'])}</p>
                                    <p><strong>Date MES Commande Strat√©gique :</strong> ${formatDate(bpteProject['Date de MES Commande Strat√©gique'])}</p>
                                    <p><strong>Statut commande strat√©gique :</strong> ${bpteProject['Statut commande strat√©gique de l\'op√©ration'] || 'N/A'}</p>
                                    <p><strong>Date commande strat√©gique :</strong> ${formatDate(bpteProject['Date de la commande strat√©gique de l\'op√©ration'])}</p>
                                    <p><strong>Date MES commande production :</strong> ${formatDate(bpteProject['Date de MES de la commande de production'])}</p>
                                    <p><strong>Statut commande production :</strong> ${bpteProject['Statut commande production de l\'op√©ration'] || 'N/A'}</p>
                                    <p><strong>Date commande production :</strong> ${formatDate(bpteProject['Date de la commande production de l\'op√©ration'])}</p>
                                    <p><strong>Date fin AVP :</strong> ${formatDate(bpteProject['Date fin AVP'])}</p>
                                    <p><strong>Date fin PRO :</strong> ${formatDate(bpteProject['Date fin PRO'])}</p>
                                    <p><strong>Date fin APO :</strong> ${formatDate(bpteProject['Date fin APO'])}</p>
                                    <p><strong>Date fin REA :</strong> ${formatDate(bpteProject['Date fin REA'])}</p>
                                    <p><strong>Date REA d√©but :</strong> ${formatDate(bpteProject['Date REA d√©but GEREMI'])}</p>
                                    <p><strong>Date REA fin :</strong> ${formatDate(bpteProject['Date REA fin GEREMI'])}</p>
                                    <p><strong>Phase en cours GEREMI :</strong> ${bpteProject['Phase en cours GEREMI'] || 'N/A'}</p>
                                    <p><strong>Phase projet√©e :</strong> ${bpteProject['Phase projet√©e'] || 'N/A'}</p>
                                    <p><strong>Statut GEREMI :</strong> ${bpteProject['Statut GEREMI'] || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; border-top: 1px solid #fd7e14; padding-top: 15px;">
                                <h4 style="color: #fd7e14; margin: 10px 0;">üè¢ Organisation & Responsabilit√©s</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                    <div>
                                        <p><strong>Direction M&T :</strong> ${bpteProject['Direction M&T'] || 'N/A'}</p>
                                        <p><strong>AMT :</strong> ${bpteProject['AMT'] || 'N/A'}</p>
                                        <p><strong>DT R√©seau :</strong> ${bpteProject['DT R√©seau'] || 'N/A'}</p>
                                        <p><strong>MOA :</strong> ${bpteProject['MOA'] || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p><strong>R√©gion SNCF :</strong> ${bpteProject['Libell√© r√©gion SNCF'] || 'N/A'}</p>
                                        <p><strong>Etab. resp. planif. annuelle :</strong> ${bpteProject['Etablissement responsable de planification annuelle'] || 'N/A'}</p>
                                        <p><strong>Etab. resp. planif. pluriannuelle :</strong> ${bpteProject['Etablissement responsable de planification pluriannuelle'] || 'N/A'}</p>
                                        <p><strong>Etab. porteur budget annuel :</strong> ${bpteProject['Etablissement porteur du budget op√©rationnel annuel'] || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p><strong>Etab. porteur budget pluriannuel :</strong> ${bpteProject['Etablissement porteur du budget op√©rationnel pluriannuel'] || 'N/A'}</p>
                                        <p><strong>Etab. resp. prog. capacit√© :</strong> ${bpteProject['Etablissement responsable de programmation capacit√© annuelle'] || 'N/A'}</p>
                                        <p><strong>Priorit√© CPA :</strong> ${bpteProject['Priorit√© CPA'] || 'N/A'}</p>
                                        <p><strong>Priorit√© PEI :</strong> ${bpteProject['Priorit√© PEI'] || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; border-top: 1px solid #fd7e14; padding-top: 15px;">
                                <h4 style="color: #fd7e14; margin: 10px 0;">üìã Projets & Libell√©s</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <p><strong>Libell√© projet pluriannuel :</strong> ${bpteProject['Libell√© projet pluriannuel'] || 'N/A'}</p>
                                        <p><strong>Libell√© projet annuel :</strong> ${bpteProject['Libell√© projet annuel'] || 'N/A'}</p>
                                        <p><strong>Libell√© projet annuel d√©clar√© :</strong> ${bpteProject['Libell√© projet annuel d√©clar√©'] || 'N/A'}</p>
                                        <p><strong>Libell√© projet GEREMI long :</strong> ${bpteProject['Libell√© projet GEREMI long'] || 'N/A'}</p>
                                        <p><strong>Libell√© op√©ration GEREMI :</strong> ${bpteProject['Libell√© op√©ration GEREMI'] || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p><strong>Libell√© p√©rim√®tre OPERA :</strong> ${bpteProject['Libell√© p√©rim√®tre OPERA de r√©f√©rence'] || 'N/A'}</p>
                                        <p><strong>Libell√© activit√© OPERA :</strong> ${bpteProject['Libell√© activit√© OPERA de r√©f√©rence'] || 'N/A'}</p>
                                        <p><strong>Libell√© axe OPERA :</strong> ${bpteProject['Libell√© axe OPERA de r√©f√©rence'] || 'N/A'}</p>
                                        <p><strong>Provenance :</strong> ${bpteProject['Provenance'] || 'N/A'}</p>
                                        <p><strong>Cartographie :</strong> ${bpteProject['Cartographie'] || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; border-top: 1px solid #fd7e14; padding-top: 15px;">
                                <h4 style="color: #fd7e14; margin: 10px 0;">üìù Descriptions & Mill√©simes</h4>
                                <p><strong>Descr RG du DO :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Descr RG du DO'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Descr RG du CDP :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Descr RG du CDP'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Mill√©sime commande production :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Mill√©sime de la commande production de l\'op√©ration'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Mill√©sime op√©ration synth√®se :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Mill√©sime de l\'op√©ration synth√®se'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Fen√™tre mill√©sime CP :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Fen√™tre mill√©sime CP (-/+5ans)'] || 'N/A') : 'N/A'}</p>
                                <p><strong>Fen√™tre mill√©sime CS :</strong> ${bpteProject.rawData ? (bpteProject.rawData['Fen√™tre mill√©sime CS (-/+5ans)'] || 'N/A') : 'N/A'}</p>
                            </div>
                            
                            ${bpteProject.description || bpteProject.commentaire ? `
                            <div style="margin-top: 15px; border-top: 1px solid #fd7e14; padding-top: 15px;">
                                <h4 style="color: #fd7e14; margin: 10px 0;">üìù Description & Commentaires</h4>
                                <div style="background: #fff; padding: 10px; border-radius: 3px; border-left: 4px solid #fd7e14;">
                                    <p style="margin: 0; font-style: italic;">${bpteProject.description || bpteProject.commentaire}</p>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 15px; text-align: center;">
                                <p style="color: #fd7e14; font-weight: bold;">
                                    üîÑ Coh√©rence Admin/BPTE : ${checkDataConsistency(project, bpteProject)}
                                </p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="window.open('https://www.openrailwaymap.org/?style=standard&lat=${getProjectCoordinates(project).lat}&lon=${getProjectCoordinates(project).lng}&zoom=15', '_blank')" 
                                style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                            üó∫Ô∏è Voir sur OpenRailwayMap
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                            Fermer
                        </button>
                    </div>
                `;
                
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Fermeture en cliquant sur le fond
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('Erreur affichage d√©tails projet:', error);
                alert('Erreur lors de l\'affichage des d√©tails du projet');
            }
        }
        
        // Fonctions utilitaires pour les d√©tails du projet
        function formatCurrency(value) {
            if (!value || isNaN(value)) return 'N/A';
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        function calculateBudgetDifference(project) {
            const cdp = parseFloat(project.F13) || 0;
            const bpte = parseFloat(project.F14) || 0;
            if (cdp === 0 && bpte === 0) return 'N/A';
            const diff = bpte - cdp;
            const color = diff > 0 ? '#dc3545' : (diff < 0 ? '#28a745' : '#17a2b8');
            return `<span style="color: ${color}; font-weight: bold;">${formatCurrency(Math.abs(diff))} ${diff > 0 ? '(d√©passement)' : diff < 0 ? '(√©conomie)' : '(conforme)'}</span>`;
        }
        
        function getInfrastructureType(project) {
            const title = (project.F7 || project.F2 || '').toLowerCase();
            if (title.includes('pont') || title.includes('viaduc')) return 'üåâ Ouvrage d\'art';
            if (title.includes('tunnel') || title.includes('souterrain')) return 'üöá Tunnel';
            if (title.includes('gare') || title.includes('station')) return 'üöâ Gare';
            if (title.includes('voie') || title.includes('rail')) return 'üõ§Ô∏è Voie ferr√©e';
            if (title.includes('passage') || title.includes('pn')) return 'üöß Passage √† niveau';
            if (title.includes('signal') || title.includes('canton')) return 'üö¶ Signalisation';
            return 'üöÇ Infrastructure ferroviaire';
        }
        
        function getGeographicZone(lignes) {
            if (!lignes) return 'Non d√©finie';
            const ligne = lignes.toString().toLowerCase();
            if (ligne.includes('toulouse') || ligne.includes('640')) return 'Sud-Ouest (Toulouse)';
            if (ligne.includes('montpellier') || ligne.includes('750')) return 'Sud (Montpellier)';
            if (ligne.includes('bordeaux') || ligne.includes('660')) return 'Aquitaine (Bordeaux)';
            if (ligne.includes('perpignan') || ligne.includes('650')) return 'Languedoc (Perpignan)';
            return 'R√©gion SNCF R√©seau Sud';
        }
        
        function getPriority(project) {
            const budget = parseFloat(project.F12) || 0;
            if (budget > 10000000) return 'üî¥ Tr√®s haute';
            if (budget > 5000000) return 'üü† Haute';
            if (budget > 1000000) return 'üü° Moyenne';
            return 'üü¢ Standard';
        }
        
        function getProgressStatus(status) {
            if (!status) return '‚ùì Non d√©fini';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('fini') || statusLower.includes('termine')) return '‚úÖ Termin√©';
            if (statusLower.includes('cours') || statusLower.includes('encours')) return 'üîÑ En cours';
            if (statusLower.includes('prevu') || statusLower.includes('planifie')) return 'üìÖ Planifi√©';
            if (statusLower.includes('suspend') || statusLower.includes('arrete')) return '‚è∏Ô∏è Suspendu';
            return 'üìã ' + status;
        }
        
        function getComplexity(project) {
            const budget = parseFloat(project.F12) || 0;
            const length = parseFloat(project.F8) || 0;
            if (budget > 20000000 || length > 50) return 'üî¥ Tr√®s complexe';
            if (budget > 10000000 || length > 20) return 'üü† Complexe';
            if (budget > 2000000 || length > 5) return 'üü° Moyenne';
            return 'üü¢ Simple';
        }
        
        function getTrafficImpact(project) {
            const title = (project.F7 || project.F2 || '').toLowerCase();
            if (title.includes('lgv') || title.includes('tgv')) return 'üî¥ Impact majeur (LGV)';
            if (title.includes('gare') || title.includes('station')) return 'üü† Impact gare';
            if (title.includes('maintenance') || title.includes('renouvellement')) return 'üü° Impact maintenance';
            return 'üü¢ Impact limit√©';
        }
        
        function checkDataConsistency(project, bpteProject) {
            if (!bpteProject) return '‚ùì Pas de correspondance BPTE';
            
            const issues = [];
            if (project.F1 !== bpteProject.F1) issues.push('Code diff√©rent');
            
            if (issues.length === 0) return '‚úÖ Donn√©es coh√©rentes';
            return '‚ö†Ô∏è ' + issues.join(', ');
        }
        
        // === NOUVELLES FONCTIONS POUR ENRICHIR LA FICHE BPTE ===
        
        function calculateLength(pkDebut, pkFin) {
            if (!pkDebut || !pkFin) return 'N/A';
            
            // Extraire les valeurs num√©riques des PK
            const parsesPK = (pk) => {
                if (!pk) return null;
                const match = pk.toString().match(/(\d+)[+.](\d+)/);
                if (match) {
                    return parseFloat(match[1]) + parseFloat(match[2]) / 1000;
                }
                return parseFloat(pk) || null;
            };
            
            const debut = parsesPK(pkDebut);
            const fin = parsesPK(pkFin);
            
            if (debut && fin && fin > debut) {
                const length = (fin - debut).toFixed(3);
                return `${length} km`;
            }
            return 'Non calculable';
        }
        
        function calculateProgress(bpteProject) {
            const budget = parseFloat(bpteProject.budget || bpteProject.montant) || 0;
            const realise = parseFloat(bpteProject.coutReel || bpteProject.realise) || 0;
            
            if (budget === 0) return 'N/A';
            return Math.round((realise / budget) * 100);
        }
        
        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'vide') return 'N/A';
            
            let date;
            
            // V√©rifier si c'est un num√©ro de s√©rie Excel (nombre > 1000 et < 100000)
            const numValue = parseFloat(dateStr);
            if (!isNaN(numValue) && numValue > 1000 && numValue < 100000) {
                // Convertir le num√©ro de s√©rie Excel en date
                // Excel compte les jours depuis le 1er janvier 1900 (avec correction pour 1900 non bissextile)
                const excelEpoch = new Date(1899, 11, 30); // 30 d√©cembre 1899
                date = new Date(excelEpoch.getTime() + numValue * 24 * 60 * 60 * 1000);
            }
            // Tenter de parser diff√©rents formats de date texte
            else if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]); // DD/MM/YYYY
                }
            } else if (dateStr.includes('-')) {
                date = new Date(dateStr); // Format ISO
            } else {
                return dateStr; // Retourner tel quel si format non reconnu
            }
            
            if (date && !isNaN(date.getTime())) {
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }
            
            return dateStr;
        }
        
        function calculateDuration(dateDebut, dateFin) {
            if (!dateDebut || !dateFin) return 'N/A';
            
            const debut = new Date(dateDebut);
            const fin = new Date(dateFin);
            
            if (isNaN(debut.getTime()) || isNaN(fin.getTime())) return 'N/A';
            
            const diffTime = Math.abs(fin - debut);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 30) {
                return `${diffDays} jours`;
            } else if (diffDays < 365) {
                const months = Math.round(diffDays / 30);
                return `${months} mois`;
            } else {
                const years = Math.round(diffDays / 365);
                return `${years} an${years > 1 ? 's' : ''}`;
            }
        }
        
        function getDetailedStatus(status) {
            if (!status) return '‚ùì Non d√©fini';
            
            const statusLower = status.toLowerCase();
            
            // Statuts financiers
            if (statusLower.includes('engage') || statusLower.includes('commande')) return 'üí∞ Engag√©';
            if (statusLower.includes('facture') || statusLower.includes('paye')) return '‚úÖ Factur√©';
            
            // Statuts techniques
            if (statusLower.includes('etude') || statusLower.includes('conception')) return 'üìê En √©tude';
            if (statusLower.includes('travaux') || statusLower.includes('chantier')) return 'üöß En travaux';
            if (statusLower.includes('reception') || statusLower.includes('livre')) return 'üéØ R√©ceptionn√©';
            
            // Statuts de planning
            if (statusLower.includes('retard') || statusLower.includes('reporte')) return '‚è∞ En retard';
            if (statusLower.includes('avance') || statusLower.includes('anticipe')) return '‚ö° En avance';
            
            // Statuts g√©n√©riques
            if (statusLower.includes('termine') || statusLower.includes('fini')) return '‚úÖ Termin√©';
            if (statusLower.includes('cours') || statusLower.includes('encours')) return 'üîÑ En cours';
            if (statusLower.includes('prevu') || statusLower.includes('planifie')) return 'üìÖ Planifi√©';
            if (statusLower.includes('suspend') || statusLower.includes('arrete')) return '‚è∏Ô∏è Suspendu';
            if (statusLower.includes('annule')) return '‚ùå Annul√©';
            
            return `üìã ${status}`;
        }
        
        function getPriorityFromBPTE(bpteProject) {
            // Analyser diff√©rents crit√®res pour d√©terminer la priorit√©
            const budget = parseFloat(bpteProject.budget || bpteProject.montant) || 0;
            const nom = (bpteProject.nom || '').toLowerCase();
            const type = (bpteProject.typeOperation || bpteProject.type || '').toLowerCase();
            
            // Priorit√© tr√®s haute
            if (budget > 50000000) return 'üî¥ Tr√®s haute (>50M‚Ç¨)';
            if (nom.includes('urgence') || nom.includes('securite')) return 'üî¥ Tr√®s haute (s√©curit√©)';
            if (type.includes('lgv') || type.includes('tgv')) return 'üî¥ Tr√®s haute (LGV)';
            
            // Priorit√© haute
            if (budget > 10000000) return 'üü† Haute (>10M‚Ç¨)';
            if (nom.includes('renouvellement') || nom.includes('modernisation')) return 'üü† Haute (renouvellement)';
            if (type.includes('pont') || type.includes('tunnel')) return 'üü† Haute (ouvrage)';
            
            // Priorit√© moyenne
            if (budget > 1000000) return 'üü° Moyenne (>1M‚Ç¨)';
            if (nom.includes('maintenance') || nom.includes('entretien')) return 'üü° Moyenne (maintenance)';
            
            // Priorit√© standard
            return 'üü¢ Standard';
        }
        
        function evaluateTrafficImpact(bpteProject) {
            const nom = (bpteProject.nom || '').toLowerCase();
            const lignes = (bpteProject.lignes || '').toLowerCase();
            
            if (nom.includes('fermeture') || nom.includes('interruption')) return 'üî¥ Fermeture ligne';
            if (nom.includes('ralentissement') || nom.includes('limitation')) return 'üü† Ralentissements';
            if (lignes.includes('lgv') || lignes.includes('tgv')) return 'üü† Impact LGV';
            if (nom.includes('maintenance') || nom.includes('nuit')) return 'üü° Cr√©neaux maintenance';
            
            return 'üü¢ Impact limit√©';
        }
        
        function evaluateTechnicalComplexity(bpteProject) {
            const nom = (bpteProject.nom || '').toLowerCase();
            const budget = parseFloat(bpteProject.budget || bpteProject.montant) || 0;
            
            if (nom.includes('tunnel') || nom.includes('souterrain')) return 'üî¥ Tr√®s complexe (tunnel)';
            if (nom.includes('pont') || nom.includes('viaduc')) return 'üî¥ Tr√®s complexe (ouvrage)';
            if (nom.includes('signalisation') || nom.includes('ertms')) return 'üü† Complexe (signalisation)';
            if (nom.includes('electrification') || nom.includes('cat√©naire')) return 'üü† Complexe (√©lectrique)';
            if (budget > 10000000) return 'üü† Complexe (budget √©lev√©)';
            if (nom.includes('renouvellement') || nom.includes('r√©novation')) return 'üü° Moyenne (renouvellement)';
            
            return 'üü¢ Standard';
        }
        
        function evaluateSecurityIssues(bpteProject) {
            const nom = (bpteProject.nom || '').toLowerCase();
            
            if (nom.includes('securite') || nom.includes('s√©curit√©')) return 'üî¥ Enjeux s√©curitaires';
            if (nom.includes('passage') && nom.includes('niveau')) return 'üü† S√©curit√© PN';
            if (nom.includes('tunnel') || nom.includes('pont')) return 'üü† S√©curit√© ouvrage';
            if (nom.includes('signalisation') || nom.includes('balisage')) return 'üü° S√©curit√© circulation';
            
            return 'üü¢ Enjeux standards';
        }
        
        function getProjectCoordinates(project) {
            // Utiliser la fonction de calcul de coordonn√©es
            const coords = calculateCoordinatesFromPK(project.F4, project.F5, project.F6);
            return { lat: coords.lat, lng: coords.lng };
        }
        
        function getStatusColor(status) {
            if (!status) return '#6c757d';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('fini') || statusLower.includes('termine')) return '#28a745';
            if (statusLower.includes('cours')) return '#17a2b8';
            if (statusLower.includes('prevu')) return '#ffc107';
            if (statusLower.includes('suspend')) return '#dc3545';
            return '#6c757d';
        }
        
        // Fonction pour ouvrir les d√©tails d'un projet depuis son code F
        function openProjectDetails(codeF) {
            try {
                // Rechercher le projet dans les correspondances
                const project = correspondances.find(item => item.code_f === codeF);
                if (!project) {
                    console.error(`Projet ${codeF} non trouv√©`);
                    alert(`Projet ${codeF} non trouv√© dans les donn√©es`);
                    return;
                }
                
                console.log('üîç Projet trouv√©:', project);
                
                // Convertir au format attendu par showProjectDetails
                const formattedProject = {
                    F1: project.code_f,
                    F2: project.nom_projet,
                    F4: project.lignes,
                    F5: project.pk_debut,
                    F6: project.pk_fin,
                    F7: project.nom_projet,
                    F8: project.longueur || '',
                    F9: project.statut || '',
                    F10: '',
                    F12: project.budget || 0,
                    F13: project.cdp || 0,
                    F14: project.bpte || 0
                };
                
                // Utiliser les vraies donn√©es BPTE de la correspondance
                const bpteProject = project.bpteData || null;
                
                console.log('üìä Donn√©es BPTE √† passer:', bpteProject);
                
                showProjectDetails(formattedProject, bpteProject);
                
            } catch (error) {
                console.error('Erreur ouverture projet:', error);
                alert('Erreur lors de l\'ouverture du projet');
            }
        }
        
        // Fonction pour ouvrir les d√©tails d'un projet depuis le code F
        function openProjectDetails(codeF) {
            console.log(`üîç Recherche des d√©tails pour le projet: ${codeF}`);
            
            // Chercher le projet dans les correspondances
            const correspondence = correspondances.find(item => item.code_f === codeF);
            if (!correspondence) {
                console.log(`‚ùå Correspondance non trouv√©e pour ${codeF}`);
                alert(`Projet ${codeF} non trouv√© dans les donn√©es`);
                return;
            }
            
            // Cr√©er un objet projet enrichi avec les donn√©es BPTE
            const project = {
                F1: correspondence.code_f,
                F2: correspondence.nom_projet,
                F4: correspondence.lignes,
                F5: correspondence.pk_debut,
                F6: correspondence.pk_fin,
                F7: correspondence.nom_projet,
                F8: correspondence.longueur || 'N/A',
                F9: correspondence.bpteData?.statut || 'En cours',
                F10: correspondence.adminData?.cep || 'SNCF R√©seau',
                F12: correspondence.bpteData?.montant || 0,
                F13: correspondence.cdp || 0,
                F14: correspondence.bpte || 0,
                // NOUVEAU: Donn√©es enrichies BPTE
                dateDebut: correspondence.bpteData?.dateDebut,
                dateFin: correspondence.bpteData?.dateFin,
                responsable: correspondence.bpteData?.responsable,
                region: correspondence.bpteData?.region,
                typeOperation: correspondence.bpteData?.typeOperation,
                priorite: correspondence.bpteData?.priorite,
                infrastructure: correspondence.bpteData?.infrastructure,
                description: correspondence.adminData?.description,
                coordinates: correspondence.coordinates
            };
            
            // Chercher correspondance BPTE si disponible
            const bpteProject = correspondence.num_geremi ? {
                F1: correspondence.num_geremi,
                F2: correspondence.nom_projet_bpte || correspondence.nom_projet
            } : null;
            
            console.log(`‚úÖ Ouverture fiche projet enrichie pour ${codeF}`);
            showProjectDetailsNew(correspondence, bpteProject);
        }
        
        // Configuration des gestionnaires de fichiers
        function setupFileHandlers() {
            const adminFileInput = document.getElementById('admin-file');
            const bpteFileInput = document.getElementById('bpte-file');
            
            if (adminFileInput) {
                adminFileInput.addEventListener('change', checkFiles);
            }
            if (bpteFileInput) {
                bpteFileInput.addEventListener('change', checkFiles);
            }
        }
        
        // V√©rification des fichiers s√©lectionn√©s
        function checkFiles() {
            const adminFile = document.getElementById('admin-file').files[0];
            const bpteFile = document.getElementById('bpte-file').files[0];
            const processBtn = document.getElementById('process-btn');
            
            console.log(`üìÇ V√©rification fichiers - ADMIN: ${adminFile ? 'OK' : 'Manquant'}, BPTE: ${bpteFile ? 'OK' : 'Manquant'}`);
            
            if (adminFile && bpteFile && processBtn) {
                processBtn.disabled = false;
                processBtn.style.opacity = '1';
                console.log(`‚úÖ Fichiers pr√™ts: ${adminFile.name} + ${bpteFile.name}`);
            } else if (processBtn) {
                processBtn.disabled = true;
                processBtn.style.opacity = '0.5';
                console.log('‚è≥ En attente des deux fichiers...');
            }
        }
        
        // Fonctions utilitaires pour parser les donn√©es BPTE
        function parseLineNumber(ligneText) {
            if (!ligneText) return null;
            
            const ligneStr = ligneText.toString().trim();
            
            // Format L650 -> 650000
            const formatL = ligneStr.match(/L(\d{3})/i);
            if (formatL) {
                return formatL[1] + '000';
            }
            
            // Format d√©j√† num√©rique 650000
            if (/^\d{6}$/.test(ligneStr)) {
                return ligneStr;
            }
            
            // Chercher dans le texte une r√©f√©rence L{3digits}
            const ligneInText = ligneStr.match(/L(\d{3})/i);
            if (ligneInText) {
                return ligneInText[1] + '000';
            }
            
            // Recherche de ville pour deviner la ligne
            const ligneStrLower = ligneStr.toLowerCase();
            if (ligneStrLower.includes('toulouse') && ligneStrLower.includes('perpignan')) {
                return '650000'; // Ligne Toulouse-Perpignan
            } else if (ligneStrLower.includes('toulouse') && ligneStrLower.includes('bayonne')) {
                return '640000'; // Ligne Toulouse-Bayonne
            } else if (ligneStrLower.includes('montpellier') || ligneStrLower.includes('marseille')) {
                return '830000'; // Ligne Montpellier-Marseille
            }
            
            return ligneStr; // Retourner tel quel si pas de correspondance
        }
        
        function parseFirstPK(pkText) {
            if (!pkText) return null;
            
            const pkStr = pkText.toString().trim();
            
            // S√©parer par des d√©limiteurs multiples
            const separators = [' - ', '-', ' √† ', ' / ', '/', ';', ','];
            let firstPK = pkStr;
            
            for (const sep of separators) {
                if (pkStr.includes(sep)) {
                    firstPK = pkStr.split(sep)[0].trim();
                    break;
                }
            }
            
            // Nettoyer et valider le format PK
            firstPK = firstPK.replace(/\s+/g, '');
            
            // V√©rifier le format XXX+XXX
            if (/^\d{1,3}\+\d{3}$/.test(firstPK)) {
                return firstPK;
            }
            
            // Essayer de corriger les formats non standards
            const pkMatch = firstPK.match(/(\d{1,3})[+.,](\d{1,3})/);
            if (pkMatch) {
                return `${pkMatch[1]}+${pkMatch[2].padStart(3, '0')}`;
            }
            
            return firstPK; // Retourner tel quel si pas de correspondance
        }

        // Traitement des fichiers Excel
        async function processFiles() {
            // Marquer le d√©but du traitement
            isProcessing = true;
            
            if (typeof XLSX === 'undefined') {
                console.error('‚ùå Erreur: Biblioth√®que XLSX non charg√©e');
                alert('Erreur: Biblioth√®que XLSX non charg√©e. Veuillez recharger la page.');
                isProcessing = false;
                return;
            }
            
            const adminFile = document.getElementById('admin-file').files[0];
            const bpteFile = document.getElementById('bpte-file').files[0];
            
            // console.log(`üìÅ Fichiers s√©lectionn√©s - ADMIN: ${adminFile ? adminFile.name : 'Aucun'}, BPTE: ${bpteFile ? bpteFile.name : 'Aucun'}`);
            
            if (!adminFile || !bpteFile) {
                alert('S√©lectionnez les deux fichiers !');
                console.error('‚ùå Fichiers manquants pour le traitement');
                isProcessing = false;
                return;
            }
            
            // Affichage du loading
            const loadingIcon = document.getElementById('loading-icon');
            const processBtn = document.getElementById('process-btn');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');
            
            if (loadingIcon) loadingIcon.style.display = 'inline-block';
            if (processBtn) {
                processBtn.disabled = true;
                processBtn.innerHTML = '<span class="loading" style="display: inline-block;"></span> TRAITEMENT EN COURS...';
            }
            if (progressBar) progressBar.style.display = 'block';
            
            console.log('‚ö° D√©marrage du traitement des fichiers Excel...');
            updateStatus('üìÇ Lecture des fichiers Excel...', 10);
            
            try {
                // Traitement ADMIN
                const adminWorkbook = XLSX.read(await adminFile.arrayBuffer(), { type: 'array' });
                const adminSheet = adminWorkbook.Sheets[adminWorkbook.SheetNames[0]];
                const adminJson = XLSX.utils.sheet_to_json(adminSheet);
                
                rawAdminData = adminJson;
                console.log(`üîç Colonnes ADMIN: ${Object.keys(adminJson[0] || {}).join(', ')}`);
                updateStatus('üìä Traitement des donn√©es ADMIN...', 30);
                
                adminData = parseAdminData(adminJson);
                console.log(`üìä ADMIN: ${adminData.length} projets trait√©s`);
                
                // Traitement BPTE
                updateStatus('üóÇÔ∏è Traitement des donn√©es BPTE...', 50);
                const bpteWorkbook = XLSX.read(await bpteFile.arrayBuffer(), { type: 'array' });
                const bpteSheet = bpteWorkbook.Sheets[bpteWorkbook.SheetNames[0]];
                const bpteJson = XLSX.utils.sheet_to_json(bpteSheet);
                
                rawBpteData = bpteJson;
                console.log(`üîç Colonnes BPTE: ${Object.keys(bpteJson[0] || {}).join(', ')}`);
                
                bpteData = parseBpteData(bpteJson);
                console.log(`üóÇÔ∏è BPTE: ${bpteData.length} op√©rations trait√©es`);
                
                // Mise √† jour des statistiques
                updateStats();
                
                // Recherche des correspondances
                updateStatus('üîç Recherche des correspondances...', 70);
                await findCorrespondances();
                
                // Sauvegarde dans Firebase
                updateStatus('üíæ Sauvegarde dans Firebase...', 85);
                try {
                    await Promise.all([
                        saveAdminDataToFirebase(adminData),
                        saveBpteDataToFirebase(bpteData)
                    ]);
                    console.log('‚úÖ Donn√©es sauvegard√©es dans Firebase');
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Erreur Firebase (non bloquante):', firebaseError);
                }
                
                updateStatus('‚úÖ Traitement termin√© !', 100);
                setTimeout(() => {
                    if (progressBar) progressBar.style.display = 'none';
                    if (statusText) statusText.textContent = '';
                }, 2000);
                
            } catch (error) {
                console.error(`‚ùå Erreur lors du traitement: ${error.message}`);
                alert(`Erreur lors du traitement des fichiers: ${error.message}`);
                updateStatus('‚ùå Erreur de traitement', 0);
            } finally {
                // Marquer la fin du traitement
                isProcessing = false;
                
                // Reset du bouton
                if (loadingIcon) loadingIcon.style.display = 'none';
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.innerHTML = 'üöÑ ANALYSER ET CARTOGRAPHIER';
                }
            }
        }
        
        // Mise √† jour du statut avec barre de progression
        function updateStatus(message, progress) {
            const statusText = document.getElementById('status-text');
            const progressFill = document.getElementById('progress-fill');
            
            // Ajouter le pourcentage au message
            const messageWithPercent = `${message} (${progress.toFixed(1)}%)`;
            
            if (statusText) statusText.textContent = messageWithPercent;
            if (progressFill) progressFill.style.width = `${progress}%`;
            
            // Log r√©duit (seulement pour les √©tapes importantes)
            if (progress === 0 || progress === 100 || progress % 25 === 0) {
                console.log(`üìä ${messageWithPercent}`);
            }
        }
        
        // Parse des donn√©es ADMIN
        function parseAdminData(adminJson) {
            return adminJson.map(row => {
                let c6 = '';
                let nom = '';
                let cep = '';
                let statut = '';
                let description = '';
                
                // NOUVEAU: Capturer TOUTES les colonnes pour les coordonn√©es GPS
                const allColumns = {};
                
                Object.keys(row).forEach(key => {
                    const keyLower = key.toLowerCase();
                    const value = row[key]?.toString().trim() || '';
                    
                    // Stocker TOUTES les colonnes dans allColumns
                    allColumns[key] = value;
                    
                    // Mapping C6 HBPTE
                    if (keyLower === 'cop_c6-h-bpte' || 
                        keyLower === 'code c6-1' ||
                        (keyLower.includes('cop') && keyLower.includes('c6') && keyLower.includes('bpte'))) {
                        c6 = value;
                    }
                    
                    // Nom du projet
                    if (keyLower === 'nom' && !keyLower.includes('statut')) {
                        nom = value;
                    }
                    
                    // CEP
                    if (keyLower === 'cep' || keyLower === 'cep 2') {
                        if (!cep) cep = value;
                    }
                    
                    // Statut
                    if (keyLower.includes('statut') && keyLower.includes('projet')) {
                        statut = value;
                    }
                    
                    // Description
                    if (keyLower.includes('libell√©') && keyLower.includes('texte')) {
                        description = value;
                    }
                });
                
                return { 
                    c6, nom, cep, statut, description,
                    rawData: row,
                    allColumns: allColumns  // NOUVEAU: Toutes les colonnes disponibles
                };
            }).filter(item => item.c6 || item.nom);
        }
        
        // Parse des donn√©es BPTE
        function parseBpteData(bpteJson) {
            return bpteJson.map(row => {
                let geremi = '';
                let nom = '';
                let lignes = '';
                let pkDebut = '';
                let pkFin = '';
                
                // NOUVEAU: Donn√©es enrichies BPTE
                let montant = '';
                let dateDebut = '';
                let dateFin = '';
                let responsable = '';
                let region = '';
                let typeOperation = '';
                let statut = '';
                let priorite = '';
                let infrastructure = '';
                
                Object.keys(row).forEach(key => {
                    const keyLower = key.toLowerCase();
                    const value = row[key]?.toString().trim() || '';
                    
                    // Num compte GEREMI
                    if (keyLower.includes('num') && keyLower.includes('compte') && keyLower.includes('geremi')) {
                        geremi = value;
                    }
                    
                    // Nom du projet
                    if (keyLower === 'nom' || keyLower.includes('projet')) {
                        if (!nom) nom = value;
                    }
                    
                    // NOUVEAU: Donn√©es financi√®res
                    if (keyLower.includes('montant') || keyLower.includes('co√ªt') || keyLower.includes('budget')) {
                        montant = value;
                    }
                    
                    // NOUVEAU: Dates
                    if (keyLower.includes('date') && keyLower.includes('d√©but')) {
                        dateDebut = value;
                    }
                    if (keyLower.includes('date') && keyLower.includes('fin')) {
                        dateFin = value;
                    }
                    
                    // NOUVEAU: Responsable/Chef de projet
                    if (keyLower.includes('responsable') || keyLower.includes('chef') || keyLower.includes('ma√Ætre')) {
                        responsable = value;
                    }
                    
                    // NOUVEAU: R√©gion/√âtablissement
                    if (keyLower.includes('r√©gion') || keyLower.includes('etablissement') || keyLower.includes('direction')) {
                        region = value;
                    }
                    
                    // NOUVEAU: Type d'op√©ration
                    if (keyLower.includes('type') && (keyLower.includes('op√©ration') || keyLower.includes('travaux'))) {
                        typeOperation = value;
                    }
                    
                    // NOUVEAU: Statut du projet
                    if (keyLower.includes('statut') || keyLower.includes('√©tat')) {
                        statut = value;
                    }
                    
                    // NOUVEAU: Priorit√©
                    if (keyLower.includes('priorit√©') || keyLower.includes('urgence')) {
                        priorite = value;
                    }
                    
                    // NOUVEAU: Infrastructure concern√©e
                    if (keyLower.includes('infrastructure') || keyLower.includes('ouvrage')) {
                        infrastructure = value;
                    }
                    
                    // Lignes - Nettoyer et parser
                    if (keyLower.includes('ligne')) {
                        const parsedLigne = parseLineNumber(value);
                        if (parsedLigne) {
                            lignes = parsedLigne;
                            console.log(`üìã Ligne pars√©e: "${value}" -> "${parsedLigne}"`);
                        } else {
                            lignes = value;
                        }
                    }
                    
                    // PK d√©but - Prendre seulement le premier PK
                    if (keyLower.includes('pk') && keyLower.includes('d√©but')) {
                        const firstPK = parseFirstPK(value);
                        if (firstPK) {
                            pkDebut = firstPK;
                            console.log(`üéØ PK d√©but pars√©: "${value}" -> "${firstPK}"`);
                        } else {
                            pkDebut = value;
                        }
                    }
                    
                    // PK fin - Prendre seulement le premier PK
                    if (keyLower.includes('pk') && keyLower.includes('fin')) {
                        const firstPK = parseFirstPK(value);
                        if (firstPK) {
                            pkFin = firstPK;
                            console.log(`üèÅ PK fin pars√©: "${value}" -> "${firstPK}"`);
                        } else {
                            pkFin = value;
                        }
                    }
                });
                
                return { 
                    geremi, nom, lignes, pkDebut, pkFin,
                    // NOUVEAU: Donn√©es enrichies
                    montant, dateDebut, dateFin, responsable, region, 
                    typeOperation, statut, priorite, infrastructure,
                    rawData: row
                };
            }).filter(item => item.geremi || item.nom);
        }
        
        // Mise √† jour des statistiques
        function updateStats() {
            const statAdmin = document.getElementById('stat-admin');
            const statBpte = document.getElementById('stat-bpte');
            const statMatches = document.getElementById('stat-matches');
            const statCoords = document.getElementById('stat-coords');
            
            if (statAdmin) statAdmin.textContent = adminData.length;
            if (statBpte) statBpte.textContent = bpteData.length;
            if (statMatches) statMatches.textContent = correspondances.length;
            if (statCoords) statCoords.textContent = correspondances.filter(c => c.coordinates).length;
        }
        
        // Recherche des correspondances
        async function findCorrespondances() {
            console.log('üîç Recherche correspondances codes F##### entre COP_C6-H-BPTE et Num Compte GEREMI...');
            
            const adminCodes = new Map();
            adminData.forEach(item => {
                const code = extractFCode(item.c6);
                if (code) {
                    adminCodes.set(code, item);
                }
            });
            
            const bpteCodes = new Map();
            bpteData.forEach(item => {
                const code = extractFCode(item.geremi);
                if (code) {
                    bpteCodes.set(code, item);
                }
            });
            
            correspondances = [];
            
            // NOUVEAU: Affichage du mode actuel
            console.log(`üîÑ Mode de traitement: ${excelOnlyMode ? 'üìç EXCEL STANDARD (GPS prioritaires)' : 'üßÆ CALCULS AVANC√âS (Excel + PK + Nominatim)'}`);
            
            // Traitement des correspondances avec optimisation selon le mode
            if (excelOnlyMode) {
                console.log('‚ö° MODE EXCEL UNIQUEMENT: Traitement rapide sans calculs PK/Nominatim');
            } else {
                console.log('üåç MODE COMPLET: D√©marrage de l\'affinage g√©ographique des projets...');
            }
            
            const totalCodes = adminCodes.size;
            let processedCount = 0;
            
            for (const [fCode, adminItem] of adminCodes) {
                // Mettre √† jour le pourcentage d'avancement
                processedCount++;
                const progressPercent = (processedCount / totalCodes) * 100;
                updateStatus(`Traitement des correspondances`, progressPercent);
                if (bpteCodes.has(fCode)) {
                    const bpteItem = bpteCodes.get(fCode);
                    const projectName = adminItem.nom || bpteItem.nom || 'Non d√©fini';
                    
                    // NOUVEAU: Fonction pour chercher les coordonn√©es GPS dans toutes les colonnes
                    function findGPSCoordinates(adminItem) {
                        if (!adminItem.allColumns) return { lat: null, lng: null };
                        
                        let latitude = null;
                        let longitude = null;
                        
                        // Strat√©gie 1: Chercher par nom de colonne (latitude, longitude, etc.)
                        Object.keys(adminItem.allColumns).forEach(colName => {
                            const colLower = colName.toLowerCase();
                            const value = adminItem.allColumns[colName];
                            
                            if (value && !isNaN(value) && value !== '' && value != null) {
                                const numValue = parseFloat(value);
                                
                                // D√©tecter latitude (entre -90 et 90)
                                if ((colLower.includes('latitude') || colLower.includes('lat') || 
                                    colLower === 'y' || colLower === 'nord' || colLower.includes('coord_y')) &&
                                    numValue >= -90 && numValue <= 90) {
                                    latitude = numValue;
                                    console.log(`üìç Latitude trouv√©e dans colonne "${colName}": ${latitude}`);
                                }
                                
                                // D√©tecter longitude (entre -180 et 180)
                                if ((colLower.includes('longitude') || colLower.includes('lng') || colLower.includes('lon') ||
                                    colLower === 'x' || colLower === 'est' || colLower.includes('coord_x')) &&
                                    numValue >= -180 && numValue <= 180) {
                                    longitude = numValue;
                                    console.log(`üìç Longitude trouv√©e dans colonne "${colName}": ${longitude}`);
                                }
                            }
                        });
                        
                        // Strat√©gie 2: Chercher par position de colonne (Z=26√®me, AA=27√®me colonne)
                        if (!latitude || !longitude) {
                            const columnNames = Object.keys(adminItem.allColumns);
                            // console.log(`üîç DEBUG colonnes disponibles: [${columnNames.slice(0, 10).join(', ')}...] (${columnNames.length} total)`);
                            
                            // Colonne Z = 26√®me (index 25), AA = 27√®me (index 26)
                            if (columnNames.length > 25 && !latitude) {
                                const zCol = adminItem.allColumns[columnNames[25]]; // Colonne Z
                                if (zCol && !isNaN(zCol) && zCol !== '' && zCol != null) {
                                    const numValue = parseFloat(zCol);
                                    if (numValue >= -90 && numValue <= 90) {
                                        latitude = numValue;
                                        console.log(`üìç Latitude trouv√©e colonne Z (${columnNames[25]}): ${latitude}`);
                                    }
                                }
                            }
                            
                            if (columnNames.length > 26 && !longitude) {
                                const aaCol = adminItem.allColumns[columnNames[26]]; // Colonne AA
                                if (aaCol && !isNaN(aaCol) && aaCol !== '' && aaCol != null) {
                                    const numValue = parseFloat(aaCol);
                                    if (numValue >= -180 && numValue <= 180) {
                                        longitude = numValue;
                                        console.log(`üìç Longitude trouv√©e colonne AA (${columnNames[26]}): ${longitude}`);
                                    }
                                }
                            }
                        }
                        
                        // Strat√©gie 3: Chercher dans toutes les colonnes num√©riques si pas encore trouv√©
                        if (!latitude || !longitude) {
                            const numericValues = [];
                            Object.keys(adminItem.allColumns).forEach(colName => {
                                const value = adminItem.allColumns[colName];
                                if (value && !isNaN(value) && value !== '' && value != null) {
                                    const numValue = parseFloat(value);
                                    if (numValue >= -180 && numValue <= 180) {
                                        numericValues.push({ name: colName, value: numValue });
                                    }
                                }
                            });
                            
                            // Chercher une paire latitude/longitude probable
                            for (let i = 0; i < numericValues.length - 1; i++) {
                                const val1 = numericValues[i];
                                const val2 = numericValues[i + 1];
                                
                                // V√©rifier si on a une paire latitude/longitude coh√©rente
                                if (val1.value >= -90 && val1.value <= 90 && 
                                    val2.value >= -180 && val2.value <= 180 &&
                                    Math.abs(val1.value) < Math.abs(val2.value)) {
                                    latitude = val1.value;
                                    longitude = val2.value;
                                    console.log(`üìç Paire GPS trouv√©e: lat=${latitude} (${val1.name}), lng=${longitude} (${val2.name})`);
                                    break;
                                }
                            }
                        }
                        
                        return { lat: latitude, lng: longitude };
                    }
                    
                    // NOUVEAU: V√©rification GPS Excel avec d√©tection intelligente
                    const gpsCoords = findGPSCoordinates(adminItem);
                    const hasDirectGPS = gpsCoords.lat && gpsCoords.lng && 
                                        !isNaN(gpsCoords.lat) && !isNaN(gpsCoords.lng) &&
                                        isFinite(gpsCoords.lat) && isFinite(gpsCoords.lng) &&
                                        gpsCoords.lat >= -90 && gpsCoords.lat <= 90 &&
                                        gpsCoords.lng >= -180 && gpsCoords.lng <= 180;
                    
                    console.log(`\nüîç Traitement projet: "${projectName}"`);
                    console.log(`üìã Donn√©es: ligne=${bpteItem.lignes}, pkDebut=${bpteItem.pkDebut}, pkFin=${bpteItem.pkFin}`);
                    console.log(`üìç GPS Excel d√©tect√©: ${hasDirectGPS ? 'OUI' : 'NON'}`);
                    if (hasDirectGPS) {
                        console.log(`üìç Coordonn√©es GPS: lat=${gpsCoords.lat}, lng=${gpsCoords.lng}`);
                    }
                    let finalCoords;
                    
                    // LOGIQUE SELON LE MODE
                    if (excelOnlyMode) {
                        // MODE EXCEL STANDARD: Utiliser prioritairement les GPS Excel
                        if (hasDirectGPS) {
                            finalCoords = {
                                lat: gpsCoords.lat,
                                lng: gpsCoords.lng,
                                source: 'Admin-Direct-GPS',
                                precision: 'Haute'
                            };
                            console.log(`‚úÖ GPS Excel utilis√©:`, finalCoords);
                        } else {
                            // Pas de GPS Excel disponible, ignorer ce projet en mode Excel
                            console.log(`‚è≠Ô∏è PROJET IGNOR√â en mode Excel (pas de coordonn√©es GPS trouv√©es): "${projectName}"`);
                            console.log(`üí° Conseil: V√©rifiez que le fichier Excel admin contient des colonnes avec coordonn√©es GPS`);
                            continue;
                        }
                    } else {
                        // MODE CALCULS AVANC√âS: Toujours recalculer avec PK + affinage, m√™me si GPS Excel existe
                        console.log(`üßÆ Mode calculs avanc√©s: Recalcul complet pour "${projectName}"`);
                        
                        if (hasDirectGPS) {
                            console.log(`üìç GPS Excel d√©tect√© mais ignor√© en mode calculs avanc√©s: ${gpsCoords.lat}, ${gpsCoords.lng}`);
                        }
                        
                        // Calcul via PK + affinage g√©ographique syst√©matique
                        const baseCoords = calculateCoordinatesFromPK(bpteItem.lignes, bpteItem.pkDebut, bpteItem.pkFin);
                        console.log(`üìç Coordonn√©es PK calcul√©es:`, baseCoords);
                        
                        // Affinage g√©ographique avec le nom du projet
                        finalCoords = await refineProjectCoordinates(
                            projectName,
                            bpteItem.lignes,
                            bpteItem.pkDebut,
                            bpteItem.pkFin,
                            baseCoords
                        );
                        console.log(`üìç Coordonn√©es apr√®s affinage g√©ographique:`, finalCoords);
                    }
                    
                    console.log(`‚ú® Coordonn√©es finales:`, finalCoords);
                    
                    correspondances.push({
                        code_f: fCode,
                        nom_projet: projectName,
                        c6_hbpte: adminItem.c6,
                        num_geremi: bpteItem.geremi,
                        lignes: bpteItem.lignes,
                        pk_debut: bpteItem.pkDebut,
                        pk_fin: bpteItem.pkFin,
                        coordinates: finalCoords,
                        adminData: adminItem,
                        bpteData: bpteItem
                    });
                }
            }
            
            console.log(`‚úÖ ${correspondances.length} correspondances trouv√©es ${excelOnlyMode ? '(Excel standard)' : '(avec calculs avanc√©s)'}`);
            correspondancesFiltrees = [...correspondances];
            
            // Mettre √† jour les stats
            updateStats();
            
            // Ajouter les marqueurs sur la carte (plus besoin de filtrage suppl√©mentaire)
            if (correspondances.length > 0) {
                addMarkersToMap();
                showResults();
            }
        }
        
        // Extraction du code F#####
        function extractFCode(str) {
            if (!str) return null;
            const match = str.toString().match(/F\d{5}/i);
            return match ? match[0].toUpperCase() : null;
        }
        
        // Fonction d'information sur le syst√®me SNCF
        function getSNCFSystemInfo() {
            const stats = {
                dataLoaded: sncfDataLoaded,
                garesCount: garesData.length,
                pnCount: passagesNiveauData.length,
                quaisCount: quaisData.length,
                cacheSize: coordinatesCache.size,
                cacheEntries: Array.from(coordinatesCache.entries()).map(([key, value]) => ({
                    key: key,
                    source: value.source
                }))
            };
            
            console.log('üöÑ √âtat du syst√®me SNCF:', stats);
            return stats;
        }
        
        // Fonction d'affinage g√©ographique pour les projets
        async function refineProjectCoordinates(projectName, lignes, pkDebut, pkFin, fallbackCoords) {
            if (!projectName || projectName.trim().length < 3) {
                return fallbackCoords;
            }
            
            try {
                console.log(`üîç Affinage g√©olocalisation pour: "${projectName}"`);
                
                // √âTAPE 1: Extraire les mots-cl√©s g√©ographiques du nom du projet
                const geoKeywords = extractGeoKeywords(projectName);
                console.log(`üìç Mots-cl√©s g√©ographiques d√©tect√©s:`, geoKeywords);
                
                // √âTAPE 2: Recherche avec Nominatim pour chaque mot-cl√©
                for (const keyword of geoKeywords) {
                    const searchCoords = await searchWithNominatim(keyword);
                    if (searchCoords) {
                        // V√©rifier que les coordonn√©es sont dans une zone coh√©rente avec la ligne
                        if (isCoherentWithLine(searchCoords, lignes, fallbackCoords)) {
                            console.log(`‚úÖ Coordonn√©es affin√©es trouv√©es via "${keyword}":`, searchCoords);
                            return {
                                ...searchCoords,
                                source: `Affin√©-${keyword}`,
                                refinedFrom: fallbackCoords.source
                            };
                        }
                    }
                }
                
                // √âTAPE 3: Si pas d'affinage trouv√©, retourner les coordonn√©es PK originales
                console.log(`üìç Pas d'affinage trouv√©, utilisation des coordonn√©es PK`);
                return fallbackCoords;
                
            } catch (error) {
                console.warn('Erreur lors de l\'affinage:', error);
                return fallbackCoords;
            }
        }
        
        // Extraire les mots-cl√©s g√©ographiques d'un nom de projet
        function extractGeoKeywords(projectName) {
            const keywords = [];
            const name = projectName.toLowerCase();
            
            // Mots-cl√©s sp√©cifiques SNCF/infrastructure
            const infraKeywords = [
                'tunnel', 'viaduc', 'pont', 'gare', 'halte', 'station',
                'passage', 'souterrain', 'a√©rien', 'tranch√©e'
            ];
            
            // Noms de villes/lieux connus en Occitanie/Sud-Ouest
            const cityPatterns = [
                'toulouse', 'perpignan', 'montpellier', 'n√Æmes', 'b√©ziers', 'narbonne',
                'bayonne', 'pau', 'tarbes', 'lourdes', 'oloron', 'orthez',
                'bordeaux', 'agen', 'auch', 'albi', 'rodez', 'millau',
                'castres', 'mazamet', 'carcassonne', 'limoux', 'foix',
                'mende', 'al√®s', 'avignon', 'arles', 'marseille',
                'castelnaudary', 'roques', 'muret', 'portet', 'fonsorbes',
                'saint-sulpice', 'villefranche', 'gaillac', 'lavaur'
            ];
            
            // 1. Rechercher les expressions compl√®tes d'infrastructure (ex: "tunnel de roques")
            for (const infra of infraKeywords) {
                const regex = new RegExp(`\\b${infra}\\s+(?:de\\s+|du\\s+|des\\s+)?([a-zA-Z]+(?:\\s+[a-zA-Z]+)?)`, 'gi');
                const matches = [...name.matchAll(regex)];
                for (const match of matches) {
                    const fullExpression = match[0].trim();
                    keywords.push(fullExpression); // "tunnel de roques"
                    
                    // Aussi ajouter juste le lieu si pertinent
                    const place = match[1].trim();
                    if (place.length > 3) {
                        keywords.push(place); // "roques"
                    }
                }
            }
            
            // 2. Rechercher les noms de villes seules
            for (const city of cityPatterns) {
                if (name.includes(city)) {
                    keywords.push(city);
                }
            }
            
            // 3. Extraire les mots entre guillemets ou parenth√®ses
            const quotedMatches = projectName.match(/"([^"]+)"|'([^']+)'|\(([^)]+)\)/g);
            if (quotedMatches) {
                quotedMatches.forEach(match => {
                    const clean = match.replace(/['"()]/g, '').trim();
                    if (clean.length > 3) {
                        keywords.push(clean);
                    }
                });
            }
            
            // Retourner les mots-cl√©s uniques, tri√©s par longueur (plus long = plus sp√©cifique)
            return [...new Set(keywords)].sort((a, b) => b.length - a.length);
        }
        
        // Rechercher avec Nominatim
        async function searchWithNominatim(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=fr&addressdetails=1`);
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const result = results[0];
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        address: result.display_name,
                        type: result.type
                    };
                }
            } catch (error) {
                console.warn(`Erreur recherche Nominatim pour "${query}":`, error);
            }
            return null;
        }
        
        // V√©rifier la coh√©rence g√©ographique avec la ligne ferroviaire
        function isCoherentWithLine(searchCoords, lignes, fallbackCoords) {
            if (!searchCoords || !fallbackCoords) return false;
            
            // Calculer la distance entre les coordonn√©es trouv√©es et les coordonn√©es PK
            const distance = calculateDistance(
                searchCoords.lat, searchCoords.lng,
                fallbackCoords.lat, fallbackCoords.lng
            );
            
            // Si les coordonn√©es PK sont peu fiables (d√©faut, interpolation lointaine), 
            // √™tre plus permissif sur la distance
            const isUnreliableSource = fallbackCoords.source && 
                (fallbackCoords.source.includes('D√©faut') || 
                 fallbackCoords.source.includes('Proche') ||
                 distance > 100); // Si d√©j√† tr√®s √©loign√©, privil√©gier Nominatim
            
            const maxDistance = isUnreliableSource ? 300 : 50; // Distance plus permissive pour coordonn√©es peu fiables
            const isCoherent = distance <= maxDistance;
            
            console.log(`üìè Distance entre recherche et PK: ${distance.toFixed(2)}km (seuil: ${maxDistance}km) -> ${isCoherent ? 'Coh√©rent' : 'Trop √©loign√©'}`);
            
            return isCoherent;
        }
        
        // Calculer la distance entre deux points GPS (formule haversine)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calcul des coordonn√©es √† partir des PK (version exacte V2 - synchrone pour projets)
        function calculateCoordinatesFromPK(lignes, pkDebut, pkFin) {
            if (!lignes || !pkDebut) {
                return { lat: 43.6045, lng: 1.4442, source: 'D√©faut-Toulouse' };
            }
            
            const ligne = lignes.toString().split(',')[0].trim();
            const cacheKey = `${ligne}_${pkDebut}`;
            
            // V√©rifier le cache d'abord
            if (coordinatesCache.has(cacheKey)) {
                return coordinatesCache.get(cacheKey);
            }
            
            // PRIORIT√â 1: Chercher dans les donn√©es JSON locales
            const localCoords = findCoordinatesInLocalData(ligne, pkDebut);
            if (localCoords) {
                coordinatesCache.set(cacheKey, localCoords);
                return localCoords;
            }
            
            // PRIORIT√â 2: Coordonn√©es par d√©faut selon la r√©gion (plus intelligent)
            const defaultCoords = getDefaultCoordinatesByLineSimple(ligne);
            coordinatesCache.set(cacheKey, defaultCoords);
            return defaultCoords;
        }

        // Test des coordonn√©es pour debug avec affinage g√©ographique
        async function testCoordinates() {
            console.log('üß™ === TEST DES COORDONN√âES AVEC AFFINAGE G√âOGRAPHIQUE ===');
            
            // Test des fonctions de parsing d'abord
            console.log('\nüîß Test parsing lignes:');
            const testLignes = ['L650', 'l640', '650000', 'Ligne L650 Toulouse-Perpignan', '830000'];
            testLignes.forEach(ligne => {
                const parsed = parseLineNumber(ligne);
                console.log(`"${ligne}" -> "${parsed}"`);
            });
            
            console.log('\nüéØ Test parsing PK:');
            const testPKs = ['11+712', '11+712 - 138+607', '123+456 / 789+012', '45,678', '67.890', '289+000 ‚Üí 310+000'];
            testPKs.forEach(pk => {
                const parsed = parseFirstPK(pk);
                console.log(`"${pk}" -> "${parsed}"`);
            });
            
            console.log('\nüåç Test extraction mots-cl√©s g√©ographiques:');
            const testNames = [
                'tunnel de roques',
                'L640_RR Toulouse Castelnaudary V1 version TTX (train REVO)',
                'Viaduc de Millau',
                'Gare de Perpignan',
                'Passage √† niveau Bayonne'
            ];
            testNames.forEach(name => {
                const keywords = extractGeoKeywords(name);
                console.log(`"${name}" -> [${keywords.join(', ')}]`);
            });
            
            // Test des coordonn√©es avec formats r√©alistes et affinage
            const testCases = [
                { 
                    ligne: '640000', 
                    pkDebut: '289+000', 
                    nom: 'tunnel de roques',
                    description: 'Exemple r√©el - Tunnel de Roques sur L640' 
                },
                { 
                    ligne: '640000', 
                    pkDebut: '289+000 ‚Üí 310+000', 
                    nom: 'L640_RR Toulouse Castelnaudary V1 version TTX (train REVO)',
                    description: 'Exemple BPTE complet avec PK multiples' 
                },
                { 
                    ligne: '650000', 
                    pkDebut: '11+712 - 138+607', 
                    nom: 'Modernisation ligne Toulouse-Perpignan',
                    description: 'Ligne L650 avec villes d√©tectables' 
                },
                { 
                    ligne: '640000', 
                    pkDebut: '000+000', 
                    nom: 'R√©novation gare Toulouse-Matabiau',
                    description: 'Gare connue avec exact match' 
                },
                { 
                    ligne: 'L830', 
                    pkDebut: '511+560 / 600+000', 
                    nom: 'Tunnel de Montpellier',
                    description: 'Ville + infrastructure d√©tectable' 
                },
                { 
                    ligne: '999999', 
                    pkDebut: '123+456', 
                    nom: 'Projet myst√®re quelque part',
                    description: 'Ligne inexistante sans g√©oloc' 
                }
            ];
            
            console.log('\nüß™ Test coordonn√©es avec affinage:');
            
            for (let i = 0; i < testCases.length; i++) {
                const test = testCases[i];
                console.log(`\n--- Test ${i + 1}: ${test.description} ---`);
                console.log(`Entr√©e brute: nom="${test.nom}", ligne="${test.ligne}", pkDebut="${test.pkDebut}"`);
                
                // Parser les donn√©es comme le ferait le vrai code
                const ligneParsee = parseLineNumber(test.ligne) || test.ligne;
                const pkParse = parseFirstPK(test.pkDebut) || test.pkDebut;
                
                console.log(`Entr√©e pars√©e: ligne="${ligneParsee}", pkDebut="${pkParse}"`);
                
                // Coordonn√©es PK de base
                const baseCoords = calculateCoordinatesFromPK(ligneParsee, pkParse, '');
                console.log(`üìç Coordonn√©es PK de base:`, baseCoords);
                
                // Affinage g√©ographique
                const refinedCoords = await refineProjectCoordinates(test.nom, ligneParsee, pkParse, '', baseCoords);
                console.log(`‚ú® Coordonn√©es affin√©es:`, refinedCoords);
                
                // Ajouter un marqueur temporaire sur la carte avec info compl√®te
                const markerColor = refinedCoords.source.includes('Affin√©') ? 'green' : (baseCoords.source.includes('D√©faut') ? 'red' : 'blue');
                const marker = L.marker([refinedCoords.lat, refinedCoords.lng], {
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${markerColor}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map)
                .bindPopup(`üß™ Test ${i + 1}: ${test.description}<br>
                    <strong>Nom:</strong> ${test.nom}<br>
                    <strong>Ligne:</strong> ${test.ligne} ‚Üí ${ligneParsee}<br>
                    <strong>PK:</strong> ${test.pkDebut} ‚Üí ${pkParse}<br>
                    <strong>Coords PK:</strong> ${baseCoords.source}<br>
                    <strong>Coords finales:</strong> ${refinedCoords.source}<br>
                    <strong>Am√©lioration:</strong> ${refinedCoords.source !== baseCoords.source ? '‚úÖ OUI' : '‚ùå NON'}`);
                
                setTimeout(() => marker.remove(), 20000); // Supprimer apr√®s 20s
            }
            
            console.log(`\nüìä Cache coordonn√©es: ${coordinatesCache.size} entr√©es`);
            console.log(`üìã Donn√©es disponibles:`);
            console.log(`- Gares: ${garesData.length}`);
            console.log(`- Passages √† niveau: ${passagesNiveauData.length}`);
            console.log(`- Quais: ${quaisData.length}`);
            
            alert('üß™ Test avec affinage termin√© ! Consultez la console (F12) pour les d√©tails.\n\nüó∫Ô∏è Marqueurs sur la carte (20s):\nüîµ Bleu = Coordonn√©es PK exactes\nüü¢ Vert = Coordonn√©es affin√©es par recherche\nüî¥ Rouge = Coordonn√©es par d√©faut');
        }

        // Fonction pour obtenir des coordonn√©es par d√©faut intelligentes (version V2)
        function getDefaultCoordinatesByLineSimple(ligne) {
            const ligneStr = ligne.toString().toLowerCase();
            
            // Coordonn√©es par r√©gion/ligne (exactement comme V2)
            if (ligneStr.includes('toulouse') || ligneStr.includes('midi')) {
                return { lat: 43.6045, lng: 1.4442, source: 'D√©faut-Toulouse' };
            } else if (ligneStr.includes('montpellier') || ligneStr.includes('beziers')) {
                return { lat: 43.6119, lng: 3.8772, source: 'D√©faut-Montpellier' };
            } else if (ligneStr.includes('bordeaux') || ligneStr.includes('aquitaine')) {
                return { lat: 44.8378, lng: -0.5792, source: 'D√©faut-Bordeaux' };
            } else if (ligneStr.includes('bayonne') || ligneStr.includes('biarritz')) {
                return { lat: 43.4832, lng: -1.4897, source: 'D√©faut-Bayonne' };
            } else if (ligneStr.includes('nimes') || ligneStr.includes('gard')) {
                return { lat: 43.8367, lng: 4.3601, source: 'D√©faut-N√Æmes' };
            } else if (ligneStr.includes('perpignan') || ligneStr.includes('catalogne')) {
                return { lat: 42.6886, lng: 2.8948, source: 'D√©faut-Perpignan' };
            } else if (ligneStr.includes('clermont') || ligneStr.includes('auvergne')) {
                return { lat: 45.7772, lng: 3.0870, source: 'D√©faut-Clermont' };
            } else if (ligneStr.includes('limoges') || ligneStr.includes('limousin')) {
                return { lat: 45.8336, lng: 1.2611, source:'D√©faut-Limoges' };
            } else if (ligneStr.includes('brive') || ligneStr.includes('correze')) {
                return { lat: 45.1590, lng: 1.5334, source: 'D√©faut-Brive' };
            }
            
            // Par d√©faut Toulouse (centre de la r√©gion)
            return { lat: 43.6045, lng: 1.4442, source: 'D√©faut-Toulouse' };
        }
        
        // Fonction pour basculer le mode Excel uniquement
        function toggleExcelOnlyMode() {
            excelOnlyMode = !excelOnlyMode;
            
            const btn = document.getElementById('excel-only-btn');
            if (btn) {
                if (excelOnlyMode) {
                    // Mode Excel activ√© (maintenant le mode par d√©faut)
                    btn.innerHTML = 'üìç MODE EXCEL';
                    btn.style.background = 'linear-gradient(45deg, #007bff, #0056b3)';
                    btn.style.color = 'white';
                    btn.title = 'Activer les calculs avanc√©s (PK + g√©ocodage)';
                } else {
                    // Mode calculs avanc√©s activ√©
                    btn.innerHTML = 'üßÆ CALCULS AVANC√âS ACTIV√âS';
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    btn.style.color = 'white';
                    btn.title = 'Revenir au mode Excel standard';
                }
            }
            
            // Si des donn√©es sont d√©j√† charg√©es, relancer l'analyse compl√®te
            if (adminData.length > 0 && bpteData.length > 0) {
                console.log(`üîÑ Basculement mode: ${excelOnlyMode ? 'üìç EXCEL STANDARD' : 'üßÆ CALCULS AVANC√âS'} - Relance de l'analyse`);
                findCorrespondances(); // Relancer l'analyse compl√®te avec le nouveau mode
            } else {
                console.log(`üîÑ Basculement mode: ${excelOnlyMode ? 'üìç EXCEL STANDARD' : 'üßÆ CALCULS AVANC√âS'} - En attente de donn√©es`);
            }
        }
        
        // Mettre √† jour les stats
        function updateStats() {
            const statAdmin = document.getElementById('stat-admin');
            const statBpte = document.getElementById('stat-bpte');
            const statMatches = document.getElementById('stat-matches');
            const statCoords = document.getElementById('stat-coords');
            
            if (statAdmin) statAdmin.textContent = adminData.length;
            if (statBpte) statBpte.textContent = bpteData.length;
            
            if (excelOnlyMode) {
                // En mode Excel standard, toutes les correspondances ont des coordonn√©es GPS directes
                if (statMatches) statMatches.textContent = `${correspondances.length} (Excel)`;
                if (statCoords) statCoords.textContent = correspondances.length;
            } else {
                // Mode calculs avanc√©s
                if (statMatches) statMatches.textContent = correspondances.length;
                if (statCoords) statCoords.textContent = correspondances.filter(c => c.coordinates).length;
            }
        }
        
        // Fonction pour obtenir des coordonn√©es par d√©faut intelligentes
        function getDefaultCoordinatesByLine(ligne, pkNum = 0) {
            // S√©curit√©: s'assurer que pkNum est un nombre valide
            if (isNaN(pkNum)) pkNum = 0;
            
            const ligneStr = ligne.toString().toLowerCase();
            
            // Coordonn√©es par r√©gion/ligne avec variation selon PK
            if (ligneStr.includes('toulouse') || ligneStr.includes('midi') || ligneStr.includes('640')) {
                // Ligne Toulouse-Bayonne ou r√©gion toulousaine
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 43.6045 + variation, 
                    lng: 1.4442 - variation * 0.5, 
                    source: 'Ligne-Toulouse-' + ligne 
                };
            } else if (ligneStr.includes('montpellier') || ligneStr.includes('beziers') || ligneStr.includes('750')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 43.6119 + variation, 
                    lng: 3.8772 + variation * 0.3, 
                    source: 'Ligne-Montpellier-' + ligne 
                };
            } else if (ligneStr.includes('bordeaux') || ligneStr.includes('aquitaine') || ligneStr.includes('660')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 44.8378 - variation, 
                    lng: -0.5792 + variation * 0.2, 
                    source: 'Ligne-Bordeaux-' + ligne 
                };
            } else if (ligneStr.includes('bayonne') || ligneStr.includes('biarritz')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 43.4832 + variation, 
                    lng: -1.4897 - variation * 0.1, 
                    source: 'Ligne-Bayonne-' + ligne 
                };
            } else if (ligneStr.includes('nimes') || ligneStr.includes('gard')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 43.8367 - variation, 
                    lng: 4.3601 + variation * 0.2, 
                    source: 'Ligne-N√Æmes-' + ligne 
                };
            } else if (ligneStr.includes('perpignan') || ligneStr.includes('catalogne') || ligneStr.includes('650')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 42.6886 + variation, 
                    lng: 2.8948 - variation * 0.3, 
                    source: 'Ligne-Perpignan-' + ligne 
                };
            } else if (ligneStr.includes('clermont') || ligneStr.includes('auvergne')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 45.7772 + variation, 
                    lng: 3.0870 - variation * 0.2, 
                    source: 'Ligne-Clermont-' + ligne 
                };
            } else if (ligneStr.includes('limoges') || ligneStr.includes('limousin')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 45.8336 - variation, 
                    lng: 1.2611 + variation * 0.4, 
                    source: 'Ligne-Limoges-' + ligne 
                };
            } else if (ligneStr.includes('brive') || ligneStr.includes('correze')) {
                const variation = (pkNum % 100) * 0.001;
                return { 
                    lat: 45.1590 + variation, 
                    lng: 1.5334 - variation * 0.1, 
                    source: 'Ligne-Brive-' + ligne 
                };
            }
            
            // Traitement des codes de lignes num√©riques
            const ligneNum = parseInt(ligne);
            if (!isNaN(ligneNum)) {
                const baseCoords = getCoordsByLineNumber(ligneNum, pkNum);
                if (baseCoords) return baseCoords;
            }
            
            // Par d√©faut Toulouse avec variation selon le PK
            const variation = (pkNum % 100) * 0.001;
            return { 
                lat: 43.6045 + variation, 
                lng: 1.4442 - variation * 0.5, 
                source: 'D√©faut-Toulouse-' + ligne 
            };
        }
        
        // Coordonn√©es par num√©ro de ligne
        function getCoordsByLineNumber(ligneNum, pkNum) {
            // S√©curit√©: s'assurer que pkNum est un nombre valide
            if (isNaN(pkNum)) pkNum = 0;
            
            const lignesCoords = {
                // Lignes principales avec coordonn√©es r√©elles
                561000: { lat: 47.2184, lng: 1.5536 }, // Tours-Vierzon
                640000: { lat: 43.6047, lng: 1.4442 }, // Toulouse-Bayonne
                650000: { lat: 43.6047, lng: 1.4442 }, // Toulouse-Perpignan
                738000: { lat: 43.6047, lng: 1.4442 }, // Toulouse-Millau
                750000: { lat: 43.2951, lng: 5.3698 }, // Marseille-Toulouse
                830000: { lat: 45.7640, lng: 4.8357 }, // Lyon-Marseille
            };
            
            const baseCoord = lignesCoords[ligneNum];
            if (baseCoord) {
                const variation = (pkNum % 100) * 0.0005;
                return {
                    lat: baseCoord.lat + variation,
                    lng: baseCoord.lng - variation * 0.3,
                    source: `Ligne-${ligneNum}-PK${pkNum}`
                };
            }
            
            return null;
        }
        
        // Fonction pour obtenir des coordonn√©es manuelles par ligne avec calcul de position
        function getManualCoordinatesByLine(ligne, pkDebut) {
            // PRIORIT√â 3: Fallback sur les coordonn√©es manuelles am√©lior√©es
            const lignesCoords = {
                // Lignes principales Occitanie - coordonn√©es corrig√©es
                '561000': { origine: { lat: 47.2184, lng: 1.5536 }, fin: { lat: 46.8033, lng: 1.6914 }, longueur: 85 }, // Tours-Vierzon
                '640000': { origine: { lat: 43.6047, lng: 1.4442 }, fin: { lat: 43.4951, lng: -1.4693 }, longueur: 300 }, // Toulouse-Bayonne
                '650000': { origine: { lat: 43.6047, lng: 1.4442 }, fin: { lat: 42.6977, lng: 2.8954 }, longueur: 250 }, // Toulouse-Perpignan
                '738000': { origine: { lat: 43.6047, lng: 1.4442 }, fin: { lat: 44.0937, lng: 3.0778 }, longueur: 160 }, // Toulouse-Millau
                '750000': { origine: { lat: 43.2951, lng: 5.3698 }, fin: { lat: 43.6047, lng: 1.4442 }, longueur: 400 }, // Marseille-Toulouse
                '830000': { origine: { lat: 45.7640, lng: 4.8357 }, fin: { lat: 43.2951, lng: 5.3698 }, longueur: 320 }, // Lyon-Marseille
                // Lignes secondaires importantes
                '560000': { origine: { lat: 43.6047, lng: 1.4442 }, fin: { lat: 43.9297, lng: 2.1481 }, longueur: 80 }, // Toulouse-Albi
                '610000': { origine: { lat: 43.6047, lng: 1.4442 }, fin: { lat: 43.2332, lng: 0.0786 }, longueur: 150 }, // Toulouse-Tarbes
                '730000': { origine: { lat: 43.6047, lng: 1.4442 }, fin: { lat: 43.8361, lng: 4.3601 }, longueur: 280 }, // Toulouse-N√Æmes
            };
            
            const ligneInfo = lignesCoords[ligne];
            if (!ligneInfo) {
                // Position par d√©faut en Occitanie
                if (!lignesInconnuesWarned.has(ligne)) {
                    console.log(`‚ö†Ô∏è Ligne ${ligne} inconnue - utilisation position par d√©faut`);
                    lignesInconnuesWarned.add(ligne);
                }
                return { lat: 43.6047, lng: 1.4442, source: `Ligne-${ligne}-D√©faut-Toulouse` };
            }
            
            const pkNum = parseFloat(pkDebut.toString().replace('+', '.'));
            if (isNaN(pkNum)) return null;
            
            const ratio = Math.min(pkNum / ligneInfo.longueur, 1);
            
            const lat = ligneInfo.origine.lat + (ligneInfo.fin.lat - ligneInfo.origine.lat) * ratio;
            const lng = ligneInfo.origine.lng + (ligneInfo.fin.lng - ligneInfo.origine.lng) * ratio;
            
            // R√©duire les messages de console (1 sur 20)
            if (Math.random() < 0.05) {
                console.log(`üìè Calcul manuel: Ligne ${ligne}, PK ${pkNum}, ratio ${ratio.toFixed(2)}`);
            }
            return { 
                lat: lat, 
                lng: lng, 
                source: `Manuel-${ligne}-PK${pkDebut}`,
                ligne: ligne,
                pk: pkDebut
            };
        }
        
        // Ajout des marqueurs sur la carte
        function addMarkersToMap() {
            // Nettoyer les anciens marqueurs
            markers.forEach(marker => {
                if (marker.remove) marker.remove();
            });
            markers = [];
            
            console.log(`üìç Ajout de ${correspondances.length} marqueurs sur la carte...`);
            
            correspondances.forEach((item, index) => {
                if (item.coordinates && 
                    !isNaN(item.coordinates.lat) && 
                    !isNaN(item.coordinates.lng) &&
                    isFinite(item.coordinates.lat) &&
                    isFinite(item.coordinates.lng)) {
                    
                    const marker = createProjectMarker(item);
                    if (marker) {
                        marker.addTo(map);
                        markers.push(marker);
                        filteredMarkers.push(marker); // Ajouter aussi aux marqueurs filtr√©s
                    }
                } else {
                    console.warn(`Coordonn√©es invalides pour le projet ${item.code_f}:`, item.coordinates);
                }
            });
            
            console.log(`‚úÖ ${markers.length} marqueurs ajout√©s`);
            
            // Mettre √† jour les informations de la carte
            updateMapInfo();
            
            // Initialiser les filtres
            initializeFilters();
            
            // Ajuster la vue pour montrer tous les marqueurs
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Cr√©ation d'un marqueur de projet
        function createProjectMarker(item) {
            if (!item.coordinates || 
                isNaN(item.coordinates.lat) || 
                isNaN(item.coordinates.lng) ||
                !isFinite(item.coordinates.lat) ||
                !isFinite(item.coordinates.lng)) {
                console.warn(`Coordonn√©es invalides pour createProjectMarker:`, item.coordinates);
                return null;
            }
            
            // D√©terminer l'ic√¥ne et la couleur selon la source des coordonn√©es
            let iconHtml = 'üöÇ';
            let color = '#003C71';
            
            // Priorit√© √† la source des coordonn√©es
            if (item.coordinates.source === 'Admin-Direct-GPS') {
                iconHtml = 'üìç';
                color = '#28a745'; // Vert pour coordonn√©es directes admin
            } else if (item.coordinates.source?.includes('Affin√©')) {
                iconHtml = 'üéØ';
                color = '#17a2b8'; // Bleu pour coordonn√©es affin√©es
            } else if (item.coordinates.source?.includes('Gare')) {
                iconHtml = 'üöâ';
                color = '#2196F3'; // Bleu gare
            } else if (item.lignes?.toString().toLowerCase().includes('passage')) {
                iconHtml = 'ÔøΩ';
                color = '#FF5722'; // Orange pour PN
            }
            
            const marker = L.marker([item.coordinates.lat, item.coordinates.lng], {
                icon: L.divIcon({
                    html: `<div style="background: ${color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'project-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            });
            
            const popupContent = `
                <div style="max-width: 350px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <div style="background: linear-gradient(135deg, #003C71, #0056b3); color: white; padding: 12px; margin: -10px -10px 15px -10px; border-radius: 8px 8px 0 0;">
                        <h3 style="margin: 0; font-size: 15px; font-weight: 600;">üìã ${item.nom_projet}</h3>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">Code F: ${item.code_f}</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 13px; color: #495057; line-height: 1.4;">
                            <div style="margin-bottom: 6px;"><strong>üìç Ligne:</strong> ${item.lignes || 'Non sp√©cifi√©'}</div>
                            <div style="margin-bottom: 6px;"><strong>üéØ PK:</strong> ${item.pk_debut} ‚Üí ${item.pk_fin}</div>
                            <div style="margin-bottom: 6px;"><strong>üè¢ GEREMI:</strong> ${item.num_geremi}</div>
                            ${item.bpteData.montant ? `<div style="margin-bottom: 6px;"><strong> Budget:</strong> ${item.bpteData.montant}</div>` : ''}
                            ${item.bpteData.responsable ? `<div style="margin-bottom: 6px;"><strong>üë§ Responsable:</strong> ${item.bpteData.responsable}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button onclick="openProjectDetails('${item.code_f}')" 
                                style="flex: 1; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            üìã Fiche d√©taill√©e
                        </button>
                        <button onclick="window.open('https://www.openrailwaymap.org/?style=standard&lat=${item.coordinates.lat}&lon=${item.coordinates.lng}&zoom=16', '_blank')" 
                                style="flex: 1; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            üó∫Ô∏è OpenRailway
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef; text-align: center;">
                        <div style="font-size: 11px; color: #6c757d;">
                            üìç ${item.coordinates.lat.toFixed(4)}, ${item.coordinates.lng.toFixed(4)}
                            ${item.coordinates.source ? ` ‚Ä¢ ${item.coordinates.source}` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            return marker;
        }
        
        // Affichage des r√©sultats
        function showResults() {
            const resultsSection = document.getElementById('results-section');
            const resultsContainer = document.getElementById('results-container');
            
            if (!resultsSection || !resultsContainer) return;
            
            resultsSection.style.display = 'block';
            
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Code F</th>
                            <th>Nom Projet</th>
                            <th>Lignes</th>
                            <th>PK D√©but</th>
                            <th>PK Fin</th>
                            <th>C6 HBPTE</th>
                            <th>GEREMI</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${correspondances.map((item, index) => `
                            <tr onclick="openProjectDetails('${item.code_f}')" style="cursor: pointer;" 
                                onmouseover="this.style.backgroundColor='#e8f5e8'" 
                                onmouseout="this.style.backgroundColor=''">
                                <td><strong>${item.code_f}</strong></td>
                                <td>${item.nom_projet}</td>
                                <td>${item.lignes || 'N/A'}</td>
                                <td>${item.pk_debut || 'N/A'}</td>
                                <td>${item.pk_fin || 'N/A'}</td>
                                <td>${item.c6_hbpte}</td>
                                <td>${item.num_geremi}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            resultsContainer.innerHTML = tableHtml;
        }
        
        // Centrer sur Toulouse
        function centerOnToulouse() {
            map.setView([43.604, 1.444], 11);
        }
        
        // Zoom sur les donn√©es
        function fitToData() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                centerOnToulouse();
            }
        }
        
        // R√©initialiser la carte
        function resetMapAndFiles() {
            // Nettoyer les marqueurs
            markers.forEach(marker => {
                if (marker.remove) marker.remove();
            });
            markers = [];
            
            // Reset des donn√©es
            adminData = [];
            bpteData = [];
            correspondances = [];
            correspondancesFiltrees = [];
            
            // Reset de l'interface
            const adminFile = document.getElementById('admin-file');
            const bpteFile = document.getElementById('bpte-file');
            const processBtn = document.getElementById('process-btn');
            const resultsSection = document.getElementById('results-section');
            
            if (adminFile) adminFile.value = '';
            if (bpteFile) bpteFile.value = '';
            if (processBtn) {
                processBtn.disabled = true;
                processBtn.style.opacity = '0.5';
            }
            if (resultsSection) resultsSection.style.display = 'none';
            
            // Reset des stats
            updateStats();
            
            // Recentrer la carte
            centerOnToulouse();
            
            console.log('üîÑ Carte et fichiers r√©initialis√©s');
        }
        
        // NOUVELLES FONCTIONNALIT√âS OPENRAILWAY
        
        // Affichage de l'infrastructure ferroviaire proche
        function showNearbyInfrastructure(lat, lng, projectName) {
            console.log(`üöâ Recherche infrastructure proche pour ${projectName}`);
            
            const radius = 2000; // 2km de rayon
            let infrastructureFound = [];
            
            // Rechercher dans les gares
            garesData.forEach(gare => {
                if (gare.latitude && gare.longitude) {
                    const distance = calculateDistance(lat, lng, gare.latitude, gare.longitude);
                    if (distance <= radius) {
                        infrastructureFound.push({
                            type: 'Gare',
                            nom: gare.libelle,
                            distance: Math.round(distance),
                            coordinates: [gare.latitude, gare.longitude]
                        });
                    }
                }
            });
            
            // Rechercher dans les passages √† niveau
            passagesNiveauData.forEach(pn => {
                if (pn.y_wgs84 && pn.x_wgs84) {
                    const distance = calculateDistance(lat, lng, pn.y_wgs84, pn.x_wgs84);
                    if (distance <= radius) {
                        infrastructureFound.push({
                            type: 'PN',
                            nom: pn.nom || pn.libelle,
                            distance: Math.round(distance),
                            coordinates: [pn.y_wgs84, pn.x_wgs84]
                        });
                    }
                }
            });
            
            // Trier par distance
            infrastructureFound.sort((a, b) => a.distance - b.distance);
            
            // Afficher les r√©sultats
            let message = `üöâ Infrastructure ferroviaire proche de "${projectName}"\\n\\n`;
            if (infrastructureFound.length > 0) {
                infrastructureFound.slice(0, 10).forEach(infra => {
                    message += `${infra.type}: ${infra.nom} (${infra.distance}m)\\n`;
                });
                message += `\\n‚ú® ${infrastructureFound.length} √©l√©ment(s) trouv√©(s) dans un rayon de ${radius/1000}km`;
            } else {
                message += `Aucune infrastructure trouv√©e dans un rayon de ${radius/1000}km`;
            }
            
            alert(message);
            
            // Ajouter des marqueurs temporaires pour l'infrastructure proche
            infrastructureFound.slice(0, 5).forEach(infra => {
                const marker = L.marker(infra.coordinates, {
                    icon: L.icon({
                        iconUrl: infra.type === 'Gare' ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png' : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup(`${infra.type}: ${infra.nom}<br>Distance: ${infra.distance}m`);
                
                // Supprimer automatiquement apr√®s 10 secondes
                setTimeout(() => {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                }, 10000);
            });
        }
        
        // Export KML d'un projet
        function exportProjectKML(codeF, projectName, lat, lng) {
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>Projet SNCF - ${projectName}</name>
        <description>Export KML du projet ${codeF}</description>
        <Style id="projectStyle">
            <IconStyle>
                <color>ff0000ff</color>
                <scale>1.2</scale>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href>
                </Icon>
            </IconStyle>
        </Style>
        <Placemark>
            <name>${projectName}</name>
            <description><![CDATA[
                <h3>Projet SNCF</h3>
                <p><strong>Code F:</strong> ${codeF}</p>
                <p><strong>Nom:</strong> ${projectName}</p>
                <p><strong>Coordonn√©es:</strong> ${lat}, ${lng}</p>
                <p><strong>Export g√©n√©r√© le:</strong> ${new Date().toLocaleString('fr-FR')}</p>
            ]]></description>
            <styleUrl>#projectStyle</styleUrl>
            <Point>
                <coordinates>${lng},${lat},0</coordinates>
            </Point>
        </Placemark>
    </Document>
</kml>`;
            
            // Cr√©er et t√©l√©charger le fichier KML
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `projet_${codeF}_${projectName.replace(/[^a-zA-Z0-9]/g, '_')}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`üìÅ Export KML g√©n√©r√© pour le projet ${projectName}`);
        }
        
        // Fonction utilitaire pour calculer la distance entre deux points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Rayon de la Terre en m√®tres
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Permettre la recherche avec la touche Entr√©e (EXACT V2)
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchLocation();
                    }
                });
            }
        });

        // Fonction de debug pour diagnostiquer les probl√®mes de donn√©es
        function showDebugInfo() {
            try {
                // V√©rifications de s√©curit√© pour √©viter les erreurs
                const adminCount = adminData ? adminData.length : 0;
                const bpteCount = bpteData ? bpteData.length : 0;
                const corrCount = correspondances ? correspondances.length : 0;
                const rawAdminCount = rawAdminData ? rawAdminData.length : 0;
                const rawBpteCount = rawBpteData ? rawBpteData.length : 0;
                
                const debugModal = document.createElement('div');
                debugModal.id = 'debugModal';
                debugModal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                    justify-content: center; align-items: center;
                `;
                
                debugModal.innerHTML = `
                    <div style="background: white; border-radius: 10px; max-width: 90%; max-height: 90%; 
                                overflow-y: auto; padding: 20px; position: relative;">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="position: absolute; top: 10px; right: 15px; background: #dc3545; 
                                       color: white; border: none; border-radius: 50%; width: 30px; height: 30px; 
                                       cursor: pointer; font-size: 16px;">√ó</button>
                        
                        <h2 style="color: #dc3545; margin-bottom: 20px;">üîç DIAGNOSTIC COMPLET DES DONN√âES</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">üìä Statistiques G√©n√©rales</h3>
                            <p><strong>Donn√©es Admin charg√©es:</strong> ${adminCount} projets</p>
                            <p><strong>Donn√©es BPTE charg√©es:</strong> ${bpteCount} op√©rations</p>
                            <p><strong>Correspondances trouv√©es:</strong> ${corrCount}</p>
                            <p><strong>Donn√©es brutes Admin:</strong> ${rawAdminCount} lignes</p>
                            <p><strong>Donn√©es brutes BPTE:</strong> ${rawBpteCount} lignes</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">üîë Codes Admin extraits (premiers 10)</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                ${adminData && adminData.length > 0 ? 
                                    adminData.slice(0, 10).map(item => {
                                        try {
                                            const fCode = extractFCode ? extractFCode(item.c6) : 'fonction extractFCode non disponible';
                                            return `${item.c6 || 'C6 vide'} ‚Üí ${fCode || 'AUCUN CODE F'}`;
                                        } catch(e) {
                                            return `${item.c6 || 'C6 vide'} ‚Üí ERREUR: ${e.message}`;
                                        }
                                    }).join('<br>')
                                    : 'Aucune donn√©e Admin ou donn√©es vides'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">üîë Codes BPTE extraits (premiers 10)</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                ${bpteData && bpteData.length > 0 ? 
                                    bpteData.slice(0, 10).map(item => {
                                        try {
                                            const fCode = extractFCode ? extractFCode(item.geremi) : 'fonction extractFCode non disponible';
                                            return `${item.geremi || 'GEREMI vide'} ‚Üí ${fCode || 'AUCUN CODE F'}`;
                                        } catch(e) {
                                            return `${item.geremi || 'GEREMI vide'} ‚Üí ERREUR: ${e.message}`;
                                        }
                                    }).join('<br>')
                                    : 'Aucune donn√©e BPTE ou donn√©es vides'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">üìã Colonnes BPTE disponibles</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                ${rawBpteData && rawBpteData.length > 0 ? Object.keys(rawBpteData[0]).join('<br>') : 'Aucune donn√©e BPTE brute'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">üìã Colonnes Admin disponibles</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                ${rawAdminData && rawAdminData.length > 0 ? Object.keys(rawAdminData[0]).join('<br>') : 'Aucune donn√©e Admin brute'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">‚úÖ Correspondances trouv√©es</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                ${correspondances && correspondances.length > 0 ? 
                                    correspondances.slice(0, 10).map(corr => {
                                        try {
                                            return `${corr.code_f || corr.fCode || 'Code vide'}: ${corr.nom_projet || (corr.adminData && corr.adminData.nom) || 'Admin sans nom'} ‚Üî ${(corr.bpteData && corr.bpteData.nom) || 'BPTE sans nom'}`;
                                        } catch(e) {
                                            return `Erreur correspondance: ${e.message}`;
                                        }
                                    }).join('<br>')
                                    : 'AUCUNE CORRESPONDANCE TROUV√âE !'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fd7e14;">üîç Premier projet BPTE brut (exemple)</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                ${rawBpteData && rawBpteData.length > 0 ? 
                                    Object.entries(rawBpteData[0]).slice(0, 20).map(([key, value]) => `${key}: ${value || 'vide'}`).join('<br>')
                                    : 'Aucune donn√©e BPTE brute'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #dc3545;">‚ö†Ô∏è √âtat des variables globales</h3>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                adminData: ${typeof adminData} (${adminData ? 'd√©fini' : 'undefined'})<br>
                                bpteData: ${typeof bpteData} (${bpteData ? 'd√©fini' : 'undefined'})<br>
                                correspondances: ${typeof correspondances} (${correspondances ? 'd√©fini' : 'undefined'})<br>
                                rawAdminData: ${typeof rawAdminData} (${rawAdminData ? 'd√©fini' : 'undefined'})<br>
                                rawBpteData: ${typeof rawBpteData} (${rawBpteData ? 'd√©fini' : 'undefined'})<br>
                                extractFCode: ${typeof extractFCode} (${extractFCode ? 'd√©fini' : 'undefined'})
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(debugModal);
                
            } catch (error) {
                console.error('Erreur dans showDebugInfo:', error);
                alert(`Erreur debug: ${error.message}`);
            }
        }

        // ========== SYST√àME DE FILTRAGE ==========
        let allCorrespondances = []; // Stockage de toutes les correspondances
        let filteredMarkers = []; // Marqueurs actuellement affich√©s
        
        // Initialiser les filtres apr√®s le traitement
        function initializeFilters() {
            if (!correspondances || correspondances.length === 0) {
                console.log('‚ö†Ô∏è Aucune correspondance trouv√©e pour initialiser les filtres');
                return;
            }
            
            console.log(`üîç Initialisation des filtres avec ${correspondances.length} correspondances`);
            
            // Copier toutes les correspondances
            allCorrespondances = [...correspondances];
            
            // Extraire les CEP uniques (Admin)
            const cepSet = new Set();
            allCorrespondances.forEach(item => {
                if (item.adminData && item.adminData.cep) {
                    cepSet.add(item.adminData.cep);
                }
            });
            
            // Extraire les lignes uniques (BPTE)
            const ligneSet = new Set();
            allCorrespondances.forEach(item => {
                if (item.lignes) {
                    // Gestion des lignes multiples s√©par√©es par des virgules
                    const lignes = item.lignes.split(',').map(l => l.trim());
                    lignes.forEach(ligne => {
                        if (ligne) ligneSet.add(ligne);
                    });
                }
            });
            
            console.log(`üìä CEP trouv√©s: ${cepSet.size}, Lignes trouv√©es: ${ligneSet.size}`);
            console.log(`üìä Exemples CEP:`, Array.from(cepSet).slice(0, 3));
            console.log(`üìä Exemples Lignes:`, Array.from(ligneSet).slice(0, 3));
            
            // Populer les selects
            populateFilterSelect('filter-cep', Array.from(cepSet).sort());
            populateFilterSelect('filter-ligne', Array.from(ligneSet).sort());
            
            // Afficher la section des filtres
            const filtersSection = document.getElementById('filters-section');
            if (filtersSection) {
                filtersSection.style.display = 'block';
                console.log('‚úÖ Section filtres affich√©e');
            } else {
                console.error('‚ùå Section filtres non trouv√©e');
            }
            
            updateFilterResults();
        }
        
        // Peupler un select avec des options
        function populateFilterSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Garder l'option "Tous"
            const allOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (allOption) select.appendChild(allOption);
            
            // Ajouter les nouvelles options
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        // Appliquer les filtres
        function applyFilters() {
            const cepFilter = document.getElementById('filter-cep').value;
            const ligneFilter = document.getElementById('filter-ligne').value;
            
            console.log(`üîç Filtres appliqu√©s: CEP='${cepFilter}', Ligne='${ligneFilter}'`);
            
            // Filtrer les correspondances
            let filtered = allCorrespondances.filter(item => {
                let matches = true;
                
                // Filtre CEP
                if (cepFilter && (!item.adminData || item.adminData.cep !== cepFilter)) {
                    matches = false;
                }
                
                // Filtre Ligne
                if (ligneFilter && (!item.lignes || !item.lignes.includes(ligneFilter))) {
                    matches = false;
                }
                
                return matches;
            });
            
            console.log(`üìä R√©sultats filtr√©s: ${filtered.length}/${allCorrespondances.length}`);
            
            // Mettre √† jour la carte et le tableau
            updateMapWithFilters(filtered);
            updateTableWithFilters(filtered);
            updateFilterResults(filtered.length);
        }
        
        // Effacer tous les filtres
        function clearFilters() {
            document.getElementById('filter-cep').value = '';
            document.getElementById('filter-ligne').value = '';
            
            // Remettre toutes les options de ligne
            updateLigneOptions();
            
            // Remettre tous les marqueurs et le tableau complet
            updateMapWithFilters(allCorrespondances);
            updateTableWithFilters(allCorrespondances);
            updateFilterResults();
        }
        
        // Mettre √† jour les options de ligne en fonction du CEP s√©lectionn√©
        function updateLigneOptions() {
            const selectedCep = document.getElementById('filter-cep').value;
            const ligneSelect = document.getElementById('filter-ligne');
            
            if (!ligneSelect) return;
            
            // Sauvegarder la s√©lection actuelle
            const currentSelection = ligneSelect.value;
            
            // R√©initialiser les options
            ligneSelect.innerHTML = '<option value="">Toutes les lignes</option>';
            
            if (!selectedCep) {
                // Aucun CEP s√©lectionn√© = toutes les lignes disponibles
                const allLignes = new Set();
                allCorrespondances.forEach(item => {
                    if (item.lignes) {
                        const lignes = item.lignes.split(',').map(l => l.trim());
                        lignes.forEach(ligne => {
                            if (ligne) allLignes.add(ligne);
                        });
                    }
                });
                
                Array.from(allLignes).sort().forEach(ligne => {
                    const option = document.createElement('option');
                    option.value = ligne;
                    option.textContent = ligne;
                    ligneSelect.appendChild(option);
                });
            } else {
                // CEP s√©lectionn√© = seulement les lignes o√π ce CEP intervient
                const lignesForCep = new Set();
                allCorrespondances.forEach(item => {
                    if (item.adminData && item.adminData.cep === selectedCep && item.lignes) {
                        const lignes = item.lignes.split(',').map(l => l.trim());
                        lignes.forEach(ligne => {
                            if (ligne) lignesForCep.add(ligne);
                        });
                    }
                });
                
                Array.from(lignesForCep).sort().forEach(ligne => {
                    const option = document.createElement('option');
                    option.value = ligne;
                    option.textContent = ligne;
                    ligneSelect.appendChild(option);
                });
                
                console.log(`üîç CEP "${selectedCep}" intervient sur ${lignesForCep.size} lignes:`, Array.from(lignesForCep));
            }
            
            // Restaurer la s√©lection si elle est encore disponible
            if (currentSelection && ligneSelect.querySelector(`option[value="${currentSelection}"]`)) {
                ligneSelect.value = currentSelection;
            }
            
            // Appliquer automatiquement les filtres apr√®s la mise √† jour des options
            // (mais seulement si on n'est pas en train de vider les filtres)
            if (selectedCep || currentSelection) {
                applyFilters();
            }
        }
        
        // Mettre √† jour la carte avec les donn√©es filtr√©es
        function updateMapWithFilters(filteredData) {
            // Supprimer tous les marqueurs existants
            filteredMarkers.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            filteredMarkers = [];
            
            // Ajouter les nouveaux marqueurs filtr√©s
            filteredData.forEach(item => {
                if (item.coordinates && 
                    !isNaN(item.coordinates.lat) && 
                    !isNaN(item.coordinates.lng) &&
                    isFinite(item.coordinates.lat) &&
                    isFinite(item.coordinates.lng)) {
                    
                    const marker = createProjectMarker(item);
                    if (marker) {
                        marker.addTo(map);
                        filteredMarkers.push(marker);
                    }
                }
            });
            
            // Mettre √† jour les informations de la carte
            updateMapInfo();
        }
        
        // Mettre √† jour le tableau avec les donn√©es filtr√©es
        function updateTableWithFilters(filteredData) {
            const resultsSection = document.getElementById('results-section');
            const resultsContainer = document.getElementById('results-container');
            
            if (!resultsSection || !resultsContainer) return;
            
            resultsSection.style.display = 'block';
            
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Code F</th>
                            <th>Nom Projet</th>
                            <th>Lignes</th>
                            <th>PK D√©but</th>
                            <th>PK Fin</th>
                            <th>C6 HBPTE</th>
                            <th>GEREMI</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map((item, index) => `
                            <tr onclick="openProjectDetails('${item.code_f}')" style="cursor: pointer;" 
                                onmouseover="this.style.backgroundColor='#e8f5e8'" 
                                onmouseout="this.style.backgroundColor=''">
                                <td><strong>${item.code_f}</strong></td>
                                <td>${item.nom_projet}</td>
                                <td>${item.lignes || 'N/A'}</td>
                                <td>${item.pk_debut || 'N/A'}</td>
                                <td>${item.pk_fin || 'N/A'}</td>
                                <td>${item.c6_hbpte}</td>
                                <td>${item.num_geremi}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            resultsContainer.innerHTML = tableHtml;
        }
        
        // Mettre √† jour l'affichage des r√©sultats de filtrage
        function updateFilterResults(count = null) {
            const resultsDiv = document.getElementById('filter-results');
            if (!resultsDiv) return;
            
            if (count === null) count = allCorrespondances.length;
            
            const total = allCorrespondances.length;
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
            
            resultsDiv.innerHTML = `
                <span style="color: #28a745; font-weight: 500;">
                    üìä Affichage: ${count} projets sur ${total} 
                    (${percentage}%)
                </span>
            `;
        }

        // Initialiser au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            initRailwayMap();
            
            // Tentative de chargement automatique depuis Firebase apr√®s un court d√©lai
            setTimeout(async () => {
                if (window.firebaseDB) {
                    console.log('üî• Tentative de chargement automatique depuis Firebase...');
                    await loadDataFromFirebaseOnStart();
                }
            }, 2000);
        });
        
        // ========== GESTION ALERTE FERMETURE PAGE ==========
        let isProcessing = false;
        
        // Emp√™cher l'alerte de fermeture pendant le traitement
        window.addEventListener('beforeunload', function(e) {
            // Ne pas afficher d'alerte, laisser la page se fermer normalement
            return undefined;
        });
    </script>
</body>
</html>
